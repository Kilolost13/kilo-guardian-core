<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bastion - Security Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="icons/favicon-64.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #00ff88;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-rows: 40px 1fr;
            grid-template-columns: 1fr 2fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
            grid-template-areas:
                "header header"
                "sidebar camera";
        }

        /* Header */
        .header {
            grid-area: header;
            background: #0a0a0a;
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        /* Hamburger Menu */
        .menu-button {
            width: 45px;
            height: 45px;
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .menu-button:hover {
            background: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
        }

        .menu-button:hover i {
            color: #000;
        }

        .menu-button i {
            font-size: 20px;
            color: #00ff88;
            transition: color 0.3s;
        }

        .dropdown-menu {
            position: absolute;
            top: 75px;
            right: 15px;
            background: #0a0a0a;
            border: 2px solid #00ff88;
            border-radius: 12px;
            width: 280px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .menu-banner {
            margin: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.4);
            background: rgba(0, 255, 136, 0.08);
            color: #c8fadd;
            font-size: 13px;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.15);
            display: none;
        }

        .menu-banner h4 {
            margin: 0 0 6px 0;
            font-size: 13px;
            letter-spacing: 0.5px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-banner p {
            margin: 0;
            color: #b5d9c8;
            line-height: 1.4;
        }

        .menu-banner.warning {
            border-color: rgba(255, 170, 0, 0.5);
            background: rgba(255, 170, 0, 0.08);
            color: #ffd78a;
            box-shadow: 0 0 12px rgba(255, 170, 0, 0.2);
        }

        .menu-banner.warning h4 {
            color: #ffbe4d;
        }

        .menu-banner.warning p {
            color: #ffd78a;
        }

        .dropdown-menu.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .menu-header {
            padding: 15px;
            background: #000;
            border-bottom: 2px solid #00ff88;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(0, 255, 136, 0.1);
            padding-left: 25px;
        }

        .menu-item i {
            width: 20px;
            font-size: 16px;
        }

        .menu-item.danger {
            color: #ff0055;
        }

        .menu-item.danger:hover {
            background: rgba(255, 0, 85, 0.1);
        }

        .menu-item.warning {
            color: #ffaa00;
        }

        .menu-item.warning:hover {
            background: rgba(255, 170, 0, 0.1);
        }

        .status-indicators {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-left: 10px;
        }

        .status-light {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: slowPulse 3s ease-in-out infinite;
            transition: all 0.5s ease;
        }

        .light.green {
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88, 0 0 25px rgba(0, 255, 136, 0.5);
        }

        .light.yellow {
            background: #ffaa00;
            box-shadow: 0 0 15px #ffaa00, 0 0 25px rgba(255, 170, 0, 0.5);
        }

        .light.red {
            background: #ff0055;
            box-shadow: 0 0 15px #ff0055, 0 0 25px rgba(255, 0, 85, 0.5);
        }

        .light.blue {
            background: #00aaff;
            box-shadow: 0 0 15px #00aaff, 0 0 25px rgba(0, 170, 255, 0.5);
        }

        @keyframes slowPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(0.95);
            }
        }

        /* Remove old pulse animation */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Camera Multiplex Container */
        .camera-container {
            grid-area: camera;
            background: #0a0a0a;
            border: 2px solid #00ff88;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .camera-header {
            padding: 12px 18px;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00ff88;
        }

        .camera-title {
            font-weight: 700;
            font-size: 18px;
            color: #00ff88;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .cycle-button {
            padding: 8px 16px;
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 6px;
            color: #00ff88;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cycle-button:hover {
            background: #00ff88;
            color: #000;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2px;
            flex: 1;
            background: #0a0a0a;
            padding: 2px;
        }

        .camera-grid.single {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
        }

        .camera-feed {
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .camera-video.loaded {
            opacity: 1;
        }

        .camera-video:not([src]) {
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-video:not([src])::after {
            content: "Loading stream...";
            color: #666;
            font-size: 14px;
        }

        .camera-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            color: #00ff88;
            border: 1px solid #00ff88;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }

        .camera-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            color: #00ff88;
            font-size: 14px;
            font-weight: 600;
            gap: 10px;
        }

        .camera-placeholder i {
            font-size: 48px;
            opacity: 0.5;
        }

        /* Control Panel */
        .control-panel {
            grid-area: sidebar;
            background: #0a0a0a;
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            overflow-y: auto;
        }

        /* System Stats Box */
        .stats-box {
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 10px;
        }

        .stats-header {
            font-size: 11px;
            font-weight: 700;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid #00ff88;
            border-radius: 4px;
            padding: 6px;
            text-align: center;
        }

        .stat-item.alert {
            border-color: #ff0055;
            animation: pulse-red 2s infinite;
        }

        .stat-label {
            font-size: 9px;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            font-family: 'Courier New', monospace;
        }

        .stat-item.alert .stat-value {
            color: #ff0055;
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 10px;
        }

        .chat-label {
            font-size: 11px;
            font-weight: 700;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .chat-input {
            width: 100%;
            padding: 8px;
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 4px;
            color: #00ff88;
            font-size: 13px;
            outline: none;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        .chat-input:focus {
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .chat-input::placeholder {
            color: rgba(0, 255, 136, 0.5);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            min-width: 520px;
        }

        .info-card {
            background: #000;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #00ff88;
            text-align: center;
            transition: all 0.3s ease;
            cursor: default;
        }

        .info-card:hover {
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
            transform: translateY(-2px);
        }

        .info-card.alert {
            border-color: #ff0055;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 0, 85, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 0, 85, 0.6);
            }
        }

        .info-label {
            font-size: 10px;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            font-family: 'Courier New', monospace;
        }

        .info-card.alert .info-value {
            color: #ff0055;
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
        }

        flex: 1;
        min-height: 200px;
        padding: 15px;
        background: #000;
        border: 2px solid #00ff88;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.6;
        overflow-y: auto;
        color: #00ff88;
        font-family: 'Courier New',
        monospace;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            min-width: 520px;
        }

        .info-card {
            background: #000;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #00ff88;
            text-align: center;
            transition: all 0.3s ease;
            cursor: default;
        }

        .info-card:hover {
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
            transform: translateY(-2px);
        }

        .info-card.alert {
            border-color: #ff0055;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 0, 85, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 0, 85, 0.6);
            }
        }

        .info-label {
            font-size: 10px;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            font-family: 'Courier New', monospace;
        }

        .info-card.alert .info-value {
            color: #ff0055;
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
        }

        .button {
            padding: 12px 24px;
            background: #00ff88;
            border: 2px solid #00ff88;
            border-radius: 8px;
            color: #000;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
            background: #000;
            color: #00ff88;
        }

        .button:active {
            transform: translateY(0);
        }

        /* Plugin Panel */
        .plugin-panel {
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .plugin-header {
            font-size: 11px;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .plugin-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            overflow-y: auto;
        }

        .plugin-item {
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .plugin-item:hover {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
            transform: translateY(-2px);
        }

        .plugin-name {
            font-size: 11px;
            color: #00ff88;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s;
        }

        .plugin-item:hover .plugin-name {
            color: #000;
        }

        .plugin-icon {
            margin-right: 8px;
            font-size: 14px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
            border: 1px solid #00ff88;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00cc70;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        /* Terminal-like text effect */
        .terminal-text {
            font-family: 'Courier New', monospace;
            color: #00ff88;
        }

        /* Glowing border animation */
        @keyframes glow-border {

            0%,
            100% {
                border-color: #00ff88;
            }

            50% {
                border-color: #00cc70;
            }
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #0a0a0a;
            border: 2px solid #00ff88;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.5);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #00ff88;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            color: #00ff88;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close-btn {
            background: none;
            border: 2px solid #00ff88;
            color: #00ff88;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .modal-close-btn:hover {
            background: #00ff88;
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .data-display {
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #00ff88;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon"><img src="icons/logo-64.png" alt="AI Assistant"></div>
                <div class="logo-text" id="headerAiName">BASTION</div>
                <div class="status-indicators">
                    <div class="status-light">
                        <div class="light green" id="systemLight"></div>
                        <span id="systemStatus">System Operational</span>
                    </div>
                </div>
            </div>
            <div class="menu-button" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </div>
        </div>

        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu">
            <div class="menu-header">SYSTEM MENU</div>
            <div class="menu-banner" id="menuBanner">
                <h4><i class="fas fa-plug"></i> Connection Notice</h4>
                <p id="menuBannerMessage">All systems nominal.</p>
            </div>
            <div class="menu-item" onclick="showDiagnostics()">
                <i class="fas fa-heartbeat"></i> System Diagnostics
            </div>
            <div class="menu-item" onclick="showLogs()">
                <i class="fas fa-file-alt"></i> System Logs
            </div>
            <div class="menu-item" onclick="showAlerts()">
                <i class="fas fa-exclamation-triangle"></i> Security Alerts
            </div>
            <div class="menu-item" onclick="showFaces()">
                <i class="fas fa-users"></i> Stored Faces
            </div>
            <div class="menu-item" onclick="showWizard()">
                <i class="fas fa-magic"></i> Setup Wizard
            </div>
            <div class="menu-item" onclick="changeAiName()">
                <i class="fas fa-robot"></i> Change AI Name
            </div>
            <div class="menu-item" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i> <span id="fullscreenText">Enter Fullscreen</span>
            </div>
            <div class="menu-item warning" onclick="restartSystem()">
                <i class="fas fa-redo"></i> Restart System
            </div>
            <div class="menu-item danger" onclick="shutdownSystem()">
                <i class="fas fa-power-off"></i> Shutdown System
            </div>
        </div>

        <!-- Camera Multiplex Display -->
        <div class="camera-container">
            <div class="camera-header">
                <div class="camera-title">
                    <i class="fas fa-video"></i>
                    <span>Live Camera Feeds</span>
                    <span id="cameraCount" style="font-size: 14px; opacity: 0.8;">0</span>
                </div>
                <div class="camera-controls">
                    <div class="cycle-button" onclick="toggleMultiplex()">
                        <i class="fas fa-th"></i> <span id="multiplexMode">Grid</span>
                    </div>
                    <div class="cycle-button" onclick="cycleCamera()">
                        <i class="fas fa-sync"></i> Cycle
                    </div>
                </div>
            </div>
            <div class="camera-grid" id="cameraGrid">
                <!-- Cameras will be dynamically loaded here -->
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <!-- System Stats -->
            <div class="stats-box">
                <div class="stats-header">
                    <i class="fas fa-chart-line"></i> SYSTEM STATUS
                </div>
                <div class="stats-grid">
                    <div class="stat-item" style="cursor: pointer;" onclick="showDiagnostics()"
                        title="Click for system diagnostics">
                        <div class="stat-label"><i class="fas fa-clock"></i> UPTIME</div>
                        <div class="stat-value" id="uptime">00:00:00</div>
                    </div>
                    <div class="stat-item" style="cursor: pointer;"
                        onclick="document.querySelector('.camera-container').scrollIntoView({behavior: 'smooth', block: 'start'})"
                        title="Click to view cameras">
                        <div class="stat-label">
                            <i class="fas fa-video"></i> CAMERAS
                            <div class="light green" id="cameraLight" style="display: inline-block; margin-left: 8px;">
                            </div>
                        </div>
                        <div class="stat-value" id="cameraCountInfo">0</div>
                    </div>
                    <div class="stat-item" style="cursor: pointer;" onclick="togglePluginHealthModal()"
                        title="Click for plugin health details">
                        <div class="stat-label">
                            <i class="fas fa-plug"></i> PLUGINS
                            <div class="light green" id="pluginHealthLight"
                                style="display: inline-block; margin-left: 8px;"></div>
                        </div>
                        <div class="stat-value" id="pluginCount">0</div>
                    </div>
                    <div class="stat-item" id="alertCard" style="cursor: pointer;" onclick="showAlerts()"
                        title="Click to view security alerts">
                        <div class="stat-label"><i class="fas fa-shield-alt"></i> THREATS</div>
                        <div class="stat-value" id="threatCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Plugin Management Panel -->
            <div class="plugin-panel">
                <div class="plugin-header">
                    <i class="fas fa-plug"></i> PLUGIN MANAGEMENT
                </div>
                <div class="plugin-list" id="pluginList">
                    Loading plugins...
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-section">
                <div class="chat-label"><i class="fas fa-comments"></i> <span id="aiNameLabel">BASTION</span> INTERFACE
                </div>
                <input type="text" class="chat-input" id="chatInput"
                    placeholder="Ask me anything... (e.g., 'check security status', 'news briefing')"
                    onkeypress="if(event.key==='Enter') sendQuery()">
                <div class="chat-response" id="chatResponse">
                    System initialized and monitoring...
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Plugin Health Modal -->
    <div id="pluginHealthModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center;">
        <div
            style="background: #0a0a0a; border: 2px solid #00ff88; border-radius: 12px; max-width: 90%; max-height: 90%; overflow: auto; box-shadow: 0 0 40px rgba(0,255,136,0.5);">
            <div
                style="padding: 20px; border-bottom: 1px solid #00ff88; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #00ff88; font-size: 18px;"><i class="fas fa-heartbeat"></i> Plugin Health
                    Monitor</h2>
                <button onclick="togglePluginHealthModal()"
                    style="background: none; border: 2px solid #00ff88; color: #00ff88; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">✕
                    Close</button>
            </div>
            <div style="padding: 20px;">
                <!-- Summary Stats -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div
                        style="flex: 1; min-width: 150px; background: #111; border: 1px solid #00ff88; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">TOTAL PLUGINS</div>
                        <div id="modalTotalPlugins" style="font-size: 24px; color: #00ff88; font-weight: bold;">0</div>
                    </div>
                    <div
                        style="flex: 1; min-width: 150px; background: #111; border: 1px solid #00ff88; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">HEALTHY</div>
                        <div id="modalHealthyPlugins" style="font-size: 24px; color: #00ff88; font-weight: bold;">0
                        </div>
                    </div>
                    <div
                        style="flex: 1; min-width: 150px; background: #111; border: 1px solid #ff4444; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">UNHEALTHY</div>
                        <div id="modalUnhealthyPlugins" style="font-size: 24px; color: #ff4444; font-weight: bold;">0
                        </div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="filterUnhealthy" onchange="filterPluginHealth()"
                            style="cursor: pointer;">
                        <span style="font-size: 13px;">Unhealthy Only</span>
                    </label>
                    <select id="isolationFilter" onchange="filterPluginHealth()"
                        style="background: #111; border: 1px solid #00ff88; color: #00ff88; padding: 6px 12px; border-radius: 6px; font-size: 13px;">
                        <option value="">All Isolation Modes</option>
                        <option value="process">Process</option>
                        <option value="thread">Thread</option>
                        <option value="none">None</option>
                    </select>
                    <input type="text" id="searchPlugin" placeholder="Search plugins..." onkeyup="filterPluginHealth()"
                        style="flex: 1; min-width: 200px; background: #111; border: 1px solid #00ff88; color: #00ff88; padding: 6px 12px; border-radius: 6px; font-size: 13px;">
                    <button onclick="resetAllPluginHealth()"
                        style="background: #ff4444; border: none; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                        <i class="fas fa-redo"></i> Reset All
                    </button>
                </div>

                <!-- Plugin Health Table -->
                <div id="pluginHealthTable" style="max-height: 400px; overflow-y: auto;">
                    Loading plugin health data...
                </div>
            </div>
        </div>
    </div>

    <!-- System Info Modals -->
    <div id="diagnosticsModal" class="modal-overlay" onclick="if(event.target===this) closeModal('diagnosticsModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-heartbeat"></i> System Diagnostics</h2>
                <button class="modal-close-btn" onclick="closeModal('diagnosticsModal')">✕ Close</button>
            </div>
            <div class="modal-body">
                <div id="diagnosticsData" class="data-display">Loading...</div>
            </div>
        </div>
    </div>

    <div id="logsModal" class="modal-overlay" onclick="if(event.target===this) closeModal('logsModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-file-alt"></i> System Logs</h2>
                <button class="modal-close-btn" onclick="closeModal('logsModal')">✕ Close</button>
            </div>
            <div class="modal-body">
                <div id="logsData" class="data-display">Loading...</div>
            </div>
        </div>
    </div>

    <div id="alertsModal" class="modal-overlay" onclick="if(event.target===this) closeModal('alertsModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Security Alerts</h2>
                <button class="modal-close-btn" onclick="closeModal('alertsModal')">✕ Close</button>
            </div>
            <div class="modal-body">
                <div id="alertsData" class="data-display">Loading...</div>
            </div>
        </div>
    </div>

    <div id="networkConfigModal" class="modal-overlay"
        onclick="if(event.target===this) closeModal('networkConfigModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-sliders-h"></i> Network Security Configuration</h2>
                <button class="modal-close-btn" onclick="closeModal('networkConfigModal')">✕ Close</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 12px;">
                    <label style="display: grid; gap: 6px;">
                        <span style="color: #ccc; font-size: 13px;">Scan method</span>
                        <select id="cfgScanMethod"
                            style="background: #111; color: #00ff88; border: 1px solid #00ff88; padding: 8px; border-radius: 6px;">
                            <option value="auto">Auto (prefer nmap)</option>
                            <option value="nmap">nmap only</option>
                            <option value="arp">ARP scan</option>
                            <option value="ping">Ping sweep</option>
                        </select>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                        <input type="checkbox" id="cfgPortScan" /> Enable port scanning (slower)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                        <input type="checkbox" id="cfgIncludeOffline" /> Include offline/previous devices
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                        <input type="checkbox" id="cfgBrowserExtension" /> Enable Browser Security Shield
                    </label>

                    <div style="border: 1px solid #333; border-radius: 6px; padding: 10px;">
                        <div style="color: #00ff88; font-weight: 600; margin-bottom: 6px;">Data collection (beyond
                            protection)</div>
                        <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                            <input type="checkbox" id="cfgCollectMetadata" /> Device metadata (name/IP/MAC)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                            <input type="checkbox" id="cfgCollectPorts" /> Open port details
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                            <input type="checkbox" id="cfgCollectSecurityEvents" /> Security events (threats)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; color: #ccc;">
                            <input type="checkbox" id="cfgCollectBrowserEvents" /> Browser events from extension
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeModal('networkConfigModal')"
                            style="background: #222; color: #ccc; border: 1px solid #444; padding: 10px 14px; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveNetworkConfig()"
                            style="background: #00ff88; color: #000; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-weight: 700;">Save</button>
                    </div>
                    <div id="networkConfigStatus" style="color: #888; font-size: 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="facesModal" class="modal-overlay" onclick="if(event.target===this) closeModal('facesModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-users"></i> Stored Faces</h2>
                <button class="modal-close-btn" onclick="closeModal('facesModal')">✕ Close</button>
            </div>
            <div class="modal-body">
                <div id="facesData" class="data-display">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const API_KEY = 'kilo-dev-key-2025';

        let startTime = Date.now();
        let cameras = [];
        let currentCameraIndex = 0;
        let isMultiplexMode = true;
        let cycleInterval = null;
        let aiName = localStorage.getItem('aiName') || 'Bastion';
        let pluginHealthData = null;
        let connectionFailures = 0;
        let connectionBannerVisible = false;
        let networkConfig = null;

        async function init() {
            // Set AI name in UI
            updateAiName();

            await updateCameraGrid();
            await loadPlugins();
            await updateSystemStatus();
            // Load plugin health safely without blocking init
            loadPluginHealth().catch(err => {
                console.warn('Plugin health not available:', err.message);
            });
            setInterval(updateUptime, 1000);
            setInterval(updateSystemStatus, 10000); // Update status every 10 seconds
            setInterval(async () => { // Poll plugin health every 15 seconds
                try {
                    const response = await fetch(API_BASE_URL + '/api/plugins/health', {
                        headers: { 'X-API-Key': API_KEY }
                    });
                    if (response.ok) {
                        pluginHealthData = await response.json();
                        updatePluginHealthIndicator();
                    } else {
                        recordConnectionFailure('plugin health');
                    }
                } catch (error) {
                    console.error('Failed to poll plugin health:', error);
                    recordConnectionFailure('plugin health');
                }
            }, 15000);

            // Setup enter key for chat
            document.getElementById('chatInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendQuery();
                }
            });

            // Close menu when clicking outside
            document.addEventListener('click', function (e) {
                const menu = document.getElementById('dropdownMenu');
                const menuButton = document.querySelector('.menu-button');
                if (!menu.contains(e.target) && !menuButton.contains(e.target)) {
                    menu.classList.remove('active');
                }
            });

            // Check for alerts periodically
            setInterval(checkAlerts, 5000);
        }

        function showConnectionBanner(message, level = 'warning') {
            const banner = document.getElementById('menuBanner');
            const msg = document.getElementById('menuBannerMessage');
            if (!banner || !msg) return;

            banner.classList.toggle('warning', level === 'warning');
            msg.textContent = message;
            banner.style.display = 'block';
            connectionBannerVisible = true;
        }

        function hideConnectionBanner() {
            const banner = document.getElementById('menuBanner');
            if (!banner) return;
            banner.style.display = 'none';
            connectionBannerVisible = false;
        }

        function recordConnectionFailure(contextMessage = 'backend connectivity') {
            connectionFailures += 1;
            const retryMsg = connectionFailures > 6
                ? 'Still reconnecting to the backend. We will keep retrying automatically.'
                : `Temporary ${contextMessage} issue. Retrying... No action needed.`;
            showConnectionBanner(retryMsg, 'warning');
        }

        function clearConnectionFailures() {
            connectionFailures = 0;
            if (connectionBannerVisible) {
                hideConnectionBanner();
            }
        }

        async function updateSystemStatus() {
            const light = document.getElementById('systemLight');
            const statusText = document.getElementById('systemStatus');

            try {
                const response = await fetch(API_BASE_URL + '/api/system/health', {
                    headers: { 'X-API-Key': 'kilo-dev-key-2025' }
                });

                if (!response.ok) {
                    recordConnectionFailure('system health');
                    if (statusText) statusText.textContent = 'Reconnecting...';
                    light.className = 'light green'; // Default to green if health check unavailable
                    return;
                }

                const data = await response.json();

                // Successful check clears banner and failures
                clearConnectionFailures();

                // Determine status based on health data
                if (data.status === 'operational' || data.status === 'degraded') {
                    light.className = 'light green'; // System is running
                    if (statusText) statusText.textContent = 'System Operational';
                } else if (data.status === 'critical') {
                    light.className = 'light yellow'; // Critical but functional
                    if (statusText) statusText.textContent = 'System Degraded';
                } else {
                    light.className = 'light green'; // Default to operational
                    if (statusText) statusText.textContent = 'System Check';
                }
            } catch (error) {
                console.error('Failed to check system status:', error);
                recordConnectionFailure('system health');
                if (statusText) statusText.textContent = 'Reconnecting...';
                light.className = 'light green'; // Default to green on error
            }
        }

        async function loadPlugins() {
            try {
                const response = await fetch(API_BASE_URL + '/api/plugins', {
                    headers: {
                        'X-API-Key': 'kilo-dev-key-2025'
                    }
                });
                if (!response.ok) {
                    recordConnectionFailure('loading plugins');
                    return;
                }
                const data = await response.json();
                const plugins = data.plugins || [];

                // Get unique plugins by name
                const uniquePlugins = {};
                plugins.forEach(plugin => {
                    if (!uniquePlugins[plugin.name]) {
                        uniquePlugins[plugin.name] = plugin;
                    }
                });

                const count = Object.keys(uniquePlugins).length;
                document.getElementById('pluginCount').textContent = count;

                // Only show main plugins (exclude VPN plugins as they have dedicated UIs)
                const mainPlugins = ['briefing', 'life_tracker', 'finance_manager', 'network_security'];
                const filteredPlugins = Object.keys(uniquePlugins).filter(name => mainPlugins.includes(name));

                // Map plugin names to icons and labels
                const pluginConfig = {
                    'briefing': { icon: 'fa-newspaper', label: 'News Briefing' },
                    'life_tracker': { icon: 'fa-heartbeat', label: 'Life Tracker' },
                    'finance_manager': { icon: 'fa-dollar-sign', label: 'Finance Manager' },
                    'network_security': { icon: 'fa-lock', label: 'Network Security' }
                };

                // Special action buttons (organized by function)
                const specialActions = [
                    // VPN & Security
                    { id: 'vpn_manager', icon: 'fa-shield-alt', label: 'VPN Manager', action: 'openVPNManager()' },
                    { id: 'vpn_client', icon: 'fa-shield', label: 'VPN Client', action: 'openVPNClient()' },
                    // Remote Control & Tracking
                    { id: 'drone_control', icon: 'fa-plane', label: 'Drone Control', action: 'openDroneControl()' },
                    { id: 'meshtastic', icon: 'fa-broadcast-tower', label: 'Meshtastic Tracker', action: 'openMeshtasticTracker()' },
                    // File Management
                    { id: 'upload_docs', icon: 'fa-cloud-upload-alt', label: 'Upload Documents', action: 'showUploadModal()' }
                ];

                // Populate plugin list with action buttons
                const pluginList = document.getElementById('pluginList');
                if (filteredPlugins.length === 0) {
                    pluginList.innerHTML = '<div style="color: #888; text-align: center; padding: 10px; font-size: 11px;">No plugins loaded</div>';
                } else {
                    let html = filteredPlugins.map(name => {
                        const config = pluginConfig[name];
                        return `
                            <div class="plugin-item" onclick="executePlugin('${name}')">
                                <i class="fas ${config.icon} plugin-icon"></i>
                                <span class="plugin-name">${config.label}</span>
                            </div>
                        `;
                    }).join('');

                    // Add special action buttons
                    html += specialActions.map(action => `
                        <div class="plugin-item" onclick="${action.action}" style="border-left: 3px solid #00ff88;">
                            <i class="fas ${action.icon} plugin-icon"></i>
                            <span class="plugin-name">${action.label}</span>
                        </div>
                    `).join('');

                    pluginList.innerHTML = html;
                }
            } catch (error) {
                console.error('Failed to load plugins:', error);
                recordConnectionFailure('loading plugins');
                document.getElementById('pluginCount').textContent = '0';
                document.getElementById('pluginList').innerHTML =
                    '<div style="color: #ff0055; text-align: center; padding: 20px;">Failed to load plugins</div>';
            }
        }

        async function executePlugin(pluginName) {
            const response = document.getElementById('chatResponse');

            // Clear previous response for clean display
            response.innerHTML = '';
            response.textContent = `Executing ${pluginName}...`;

            try {
                let query = '';

                // Map plugin names to appropriate queries that match their keywords
                switch (pluginName) {
                    case 'briefing':
                        query = 'news briefing';
                        break;
                    case 'life_tracker':
                        query = 'show my health';
                        break;
                    case 'finance_manager':
                        // Show banking options modal instead of executing directly
                        showBankingModal();
                        return;
                    case 'network_security':
                        query = 'check network security';
                        break;
                    case 'security_camera':
                        query = 'show security cameras';
                        break;
                    case 'banking_csv':
                        // Create file upload dialog
                        uploadBankingCSV();
                        return;
                    default:
                        query = pluginName;
                }

                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }

                // Use the same rendering logic as sendQuery
                const pluginResponse = data.answer || data;

                if (pluginResponse.type === 'briefing') {
                    renderBriefing(pluginResponse);
                } else if (pluginResponse.type === 'finance_help') {
                    renderFinanceHelp(pluginResponse);
                } else if (pluginResponse.type === 'network_security_help' || pluginResponse.type === 'network_scan_complete') {
                    renderNetworkSecurity(pluginResponse);
                } else if (pluginResponse.type && pluginResponse.type.includes('life')) {
                    // All life tracker types: life_tracker_help, life_admin_suggestions, etc.
                    renderLifeTracking(pluginResponse);
                } else if (pluginResponse.type && (
                    pluginResponse.type === 'activity_status' ||
                    pluginResponse.type === 'sedentary_feedback' ||
                    pluginResponse.type === 'reminders_list' ||
                    pluginResponse.type === 'wellness_summary' ||
                    pluginResponse.type === 'tasks_list' ||
                    pluginResponse.type === 'reminder_added' ||
                    pluginResponse.type === 'task_added' ||
                    pluginResponse.type === 'activity_logged'
                )) {
                    // All other life tracker response types
                    renderLifeTracking(pluginResponse);
                } else if (pluginResponse.content) {
                    // Format content nicely
                    if (typeof pluginResponse.content === 'object') {
                        renderStructuredData(pluginResponse);
                    } else {
                        response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(String(pluginResponse.content))}</div>`;
                    }
                } else {
                    // Fallback to formatted JSON
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #1a1a1a; padding: 15px; border-radius: 6px; color: #ccc;">${escapeHtmlGlobal(JSON.stringify(pluginResponse, null, 2))}</pre>`;
                }
            } catch (error) {
                response.innerHTML = `<div style="color: #f44336; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #f44336;">❌ Error: ${escapeHtmlGlobal(error.message)}</div>`;
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('active');
        }

        function updateUptime() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('uptime').textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function loadCameras() {
            try {
                const response = await fetch(API_BASE_URL + '/api/cameras');
                const data = await response.json();
                return data.cameras || [];
            } catch (error) {
                console.error('Failed to load cameras:', error);
                recordConnectionFailure('loading cameras');
                return [];
            }
        }

        async function updateCameraGrid() {
            cameras = await loadCameras();
            const grid = document.getElementById('cameraGrid');
            document.getElementById('cameraCount').textContent = `(${cameras.length})`;
            document.getElementById('cameraCountInfo').textContent = cameras.length;

            if (cameras.length === 0) {
                grid.innerHTML = '<div class="camera-feed"><div class="camera-placeholder"><i class="fas fa-video-slash"></i><span>No cameras detected</span></div></div>';
                return;
            }

            renderCameras();
        }

        function renderCameras() {
            const grid = document.getElementById('cameraGrid');
            const timestamp = Date.now(); // Cache buster

            if (isMultiplexMode) {
                // Show all cameras in grid
                grid.className = 'camera-grid';
                grid.innerHTML = cameras.map(camera => `
                    <div class="camera-feed">
                        <div class="camera-label">${camera.name}</div>
                        <img class="camera-video" 
                             data-camera-id="${camera.id}"
                             alt="Camera ${camera.id}"
                             onload="this.classList.add('loaded')"
                             onerror="console.error('Camera ${camera.id} failed'); this.style.display='none'; this.parentElement.innerHTML='<div class=\\'camera-placeholder\\'><i class=\\'fas fa-exclamation-triangle\\'></i><span>Stream Error (${camera.id})</span></div>'">
                    </div>
                `).join('');
            } else {
                // Show single camera (cycling)
                grid.className = 'camera-grid single';
                const camera = cameras[currentCameraIndex];
                grid.innerHTML = `
                    <div class="camera-feed">
                        <div class="camera-label">${camera.name} (${currentCameraIndex + 1}/${cameras.length})</div>
                        <img class="camera-video" 
                             data-camera-id="${camera.id}"
                             alt="Camera ${camera.id}"
                             onload="this.classList.add('loaded')"
                             onerror="console.error('Camera ${camera.id} failed'); this.style.display='none'; this.parentElement.innerHTML='<div class=\\'camera-placeholder\\'><i class=\\'fas fa-exclamation-triangle\\'></i><span>Stream Error (${camera.id})</span></div>'">
                    </div>
                `;
            }

            // Delay stream loading to prevent continuous tab loading indicator
            setTimeout(() => {
                document.querySelectorAll('.camera-video[data-camera-id]').forEach(img => {
                    const cameraId = img.getAttribute('data-camera-id');
                    img.src = `/api/camera/${cameraId}/stream?t=${timestamp}`;
                });
            }, 100);
        }

        function toggleMultiplex() {
            isMultiplexMode = !isMultiplexMode;
            document.getElementById('multiplexMode').textContent = isMultiplexMode ? 'Grid' : 'Single';

            if (!isMultiplexMode && !cycleInterval) {
                cycleInterval = setInterval(cycleCamera, 5000);
            } else if (isMultiplexMode && cycleInterval) {
                clearInterval(cycleInterval);
                cycleInterval = null;
            }

            renderCameras();
        }

        function cycleCamera() {
            if (cameras.length === 0) return;
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            if (!isMultiplexMode) {
                renderCameras();
            }
        }

        async function checkAlerts() {
            // Placeholder for real alert checking
            const alertCard = document.getElementById('alertCard');
            const threatCount = document.getElementById('threatCount');

            // Simulate checking for threats (replace with real API call)
            const threats = 0; // Replace with actual threat detection
            threatCount.textContent = threats;

            if (threats > 0) {
                alertCard.classList.add('alert');
            } else {
                alertCard.classList.remove('alert');
            }
        }

        async function sendQuery() {
            const input = document.getElementById('chatInput');
            const response = document.getElementById('chatResponse');
            const query = input.value.trim();

            if (!query) return;

            // Clear previous response
            response.innerHTML = '';
            response.textContent = 'Processing...';

            try {
                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }

                // Helper function to safely escape HTML
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                }

                // Unwrap the response if it's wrapped in "answer"
                const pluginResponse = data.answer || data;

                // DEBUG: Log the response to console
                console.log('Chat response received:', pluginResponse);
                console.log('Response type:', pluginResponse.type);

                // Handle different response types
                if (pluginResponse.type === 'interactive_form') {
                    renderInteractiveForm(pluginResponse);
                } else if (pluginResponse.type === 'error') {
                    const errorMsg = escapeHtml(pluginResponse.error || pluginResponse.message || 'Unknown error');
                    response.innerHTML = `<div style="color: #f44336;">❌ Error: ${errorMsg}</div>`;
                } else if (pluginResponse.type === 'briefing') {
                    renderBriefing(pluginResponse);
                } else if (pluginResponse.type === 'finance_help') {
                    renderFinanceHelp(pluginResponse);
                } else if (pluginResponse.type && ['budget_status', 'spending_analysis', 'spending_summary', 'goals_status', 'grocery_lists', 'financial_advice', 'financial_overview'].includes(pluginResponse.type)) {
                    renderFinanceResponse(pluginResponse);
                } else if (pluginResponse.content) {
                    // Handle normal plugin responses with content
                    if (typeof pluginResponse.content === 'object') {
                        const jsonStr = escapeHtml(JSON.stringify(pluginResponse.content, null, 2));
                        response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; color: #4CAF50; font-size: 12px;">${jsonStr}</pre>`;
                    } else {
                        const contentStr = escapeHtml(String(pluginResponse.content));
                        response.innerHTML = `<div style="color: #4CAF50; white-space: pre-wrap;">${contentStr}</div>`;
                    }
                } else if (typeof pluginResponse === 'string') {
                    // Simple string response
                    const responseStr = escapeHtml(pluginResponse);
                    response.innerHTML = `<div style="color: #4CAF50; white-space: pre-wrap;">${responseStr}</div>`;
                } else {
                    // Unknown format - show JSON
                    const jsonStr = escapeHtml(JSON.stringify(pluginResponse, null, 2));
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${jsonStr}</pre>`;
                }
            } catch (error) {
                const errorMsg = escapeHtml(error.message);
                response.innerHTML = `<div style="color: #f44336;">❌ Error: ${errorMsg}</div>`;
            }

            input.value = '';
        }

        function renderInteractiveForm(data) {
            const response = document.getElementById('chatResponse');
            const form = data.form;

            let html = `
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #4CAF50;">${form.title || 'Form'}</h3>
                    ${data.message ? `<p style="color: #ccc; margin-bottom: 15px;">${data.message}</p>` : ''}
                    <form id="dynamicForm" style="display: flex; flex-direction: column; gap: 12px;">
            `;

            // Render form fields
            form.fields.forEach(field => {
                html += `<div style="display: flex; flex-direction: column; gap: 4px;">`;
                html += `<label style="color: #aaa; font-size: 12px;">${field.label}${field.required ? ' *' : ''}</label>`;

                if (field.type === 'select') {
                    html += `<select name="${field.name}" ${field.required ? 'required' : ''} 
                             style="padding: 8px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;">`;
                    field.options.forEach(opt => {
                        html += `<option value="${opt}">${opt}</option>`;
                    });
                    html += `</select>`;
                } else if (field.type === 'textarea') {
                    html += `<textarea name="${field.name}" ${field.required ? 'required' : ''}
                             style="padding: 8px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px; min-height: 80px;"></textarea>`;
                } else {
                    html += `<input type="${field.type}" name="${field.name}" ${field.required ? 'required' : ''}
                             style="padding: 8px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;">`;
                }
                html += `</div>`;
            });

            html += `
                        <button type="submit" style="padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px;">
                            Submit
                        </button>
                    </form>
                </div>
            `;

            response.innerHTML = html;

            // Handle form submission
            document.getElementById('dynamicForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const formValues = Object.fromEntries(formData.entries());

                response.textContent = 'Submitting...';

                try {
                    // Submit form data back to the plugin
                    const result = await fetch(API_BASE_URL + '/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'kilo-dev-key-2025'
                        },
                        body: JSON.stringify({
                            tool: data.tool,
                            action: form.action || 'submit',
                            data: formValues
                        })
                    });

                    let resultData;
                    const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                    if (resultContentType && resultContentType.includes('application/json')) {
                        resultData = await result.json();
                    } else {
                        const text = await result.text();
                        resultData = { answer: text };
                    }
                    response.innerHTML = `<div style="color: #4CAF50;">✅ ${resultData.message || 'Form submitted successfully!'}</div>`;
                } catch (error) {
                    response.innerHTML = `<div style="color: #f44336;">❌ Error: ${error.message}</div>`;
                }
            });
        }

        function renderBriefing(data) {
            const response = document.getElementById('chatResponse');

            // Helper function to safely escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        ${escapeHtml(data.briefing_type || 'Briefing')} for ${escapeHtml(data.user || 'User')}
                    </h2>
                    <div style="color: #888; font-size: 12px; margin-bottom: 20px;">
                        ${new Date(data.timestamp).toLocaleString()}
                    </div>
            `;

            if (data.sections && data.sections.length > 0) {
                data.sections.forEach(section => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">
                            <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">
                                ${escapeHtml(section.title || section.type || 'Section')}
                            </h3>
                    `;

                    if (section.content) {
                        if (typeof section.content === 'string') {
                            html += `<p style="margin: 0; color: #ccc;">${escapeHtml(section.content)}</p>`;
                        } else if (Array.isArray(section.content)) {
                            html += '<ul style="margin: 5px 0; padding-left: 20px; color: #ccc;">';
                            section.content.forEach(item => {
                                const itemText = typeof item === 'string' ? item : JSON.stringify(item);
                                html += `<li style="margin: 5px 0;">${escapeHtml(itemText)}</li>`;
                            });
                            html += '</ul>';
                        } else {
                            html += `<pre style="margin: 5px 0; color: #ccc; white-space: pre-wrap; font-family: monospace; font-size: 12px;">${escapeHtml(JSON.stringify(section.content, null, 2))}</pre>`;
                        }
                    }

                    if (section.items && Array.isArray(section.items)) {
                        html += '<ul style="margin: 5px 0; padding-left: 20px; color: #ccc;">';
                        section.items.forEach(item => {
                            html += `<li style="margin: 5px 0;">${escapeHtml(String(item))}</li>`;
                        });
                        html += '</ul>';
                    }

                    html += '</div>';
                });
            }

            html += '</div>';
            response.innerHTML = html;
        }

        // Global escapeHtml for use in inline handlers
        function escapeHtmlGlobal(text) {
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Show banking upload options modal
        function showBankingModal() {
            const modal = document.createElement('div');
            modal.id = 'bankingModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: #0a0a0a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);">
                    <h2 style="margin: 0 0 20px 0; color: #00ff88; text-align: center; font-size: 24px;">💰 Finance Manager</h2>
                    <p style="color: #888; text-align: center; margin-bottom: 25px; font-size: 14px;">What would you like to do?</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="showSetBudgetModal(); closeBankingModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-pie" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Create/View Budget</div>
                                <div style="font-size: 11px; color: #666;">Set monthly spending limits by category</div>
                            </div>
                        </button>
                        
                        <button onclick="showGroceryListModal(); closeBankingModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-shopping-cart" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Grocery List</div>
                                <div style="font-size: 11px; color: #666;">Create and manage shopping lists</div>
                            </div>
                        </button>
                        
                        <button onclick="showAddGoalModal(); closeBankingModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-bullseye" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Financial Goals</div>
                                <div style="font-size: 11px; color: #666;">Plan and track savings goals</div>
                            </div>
                        </button>
                        
                        <button onclick="showSpendingAnalysisModal(); closeBankingModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-line" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Spending Analysis</div>
                                <div style="font-size: 11px; color: #666;">View spending patterns and insights</div>
                            </div>
                        </button>
                        
                        <button onclick="showAddTransactionModal(); closeBankingModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-plus-circle" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Add Transaction</div>
                                <div style="font-size: 11px; color: #666;">Manually log expense or income</div>
                            </div>
                        </button>
                    </div>
                    
                    <button onclick="closeBankingModal()" style="width: 100%; margin-top: 20px; padding: 12px; background: rgba(255, 0, 85, 0.1); border: 2px solid #ff0055; border-radius: 8px; color: #ff0055; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                        ✕ Cancel
                    </button>
                </div>
            `;

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeBankingModal();
                }
            });

            document.body.appendChild(modal);
        }

        // Execute finance manager action
        async function executeFinanceAction(query) {
            const response = document.getElementById('chatResponse');
            response.innerHTML = '';
            response.textContent = `Processing: ${query}...`;

            try {
                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }
                const pluginResponse = data.answer || data;

                if (pluginResponse.type === 'finance_help') {
                    renderFinanceHelp(pluginResponse);
                } else if (pluginResponse.content) {
                    if (typeof pluginResponse.content === 'object') {
                        renderStructuredData(pluginResponse);
                    } else {
                        response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(String(pluginResponse.content))}</div>`;
                    }
                } else {
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #1a1a1a; padding: 15px; border-radius: 6px; color: #ccc;">${escapeHtmlGlobal(JSON.stringify(pluginResponse, null, 2))}</pre>`;
                }
            } catch (error) {
                response.innerHTML = `<div style="color: #f44336; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #f44336;">❌ Error: ${escapeHtmlGlobal(error.message)}</div>`;
            }
        }

        function closeBankingModal() {
            const modal = document.getElementById('bankingModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show grocery list creation modal
        function showGroceryListModal() {
            const modal = document.createElement('div');
            modal.id = 'groceryListModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 255, 136, 0.3);">
                    <h2 style="margin: 0 0 20px 0; color: #00ff88; font-family: monospace; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                        🛒 Create Grocery List
                    </h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #00ff88; margin-bottom: 5px; font-family: monospace; font-size: 14px;">List Name:</label>
                        <input type="text" id="groceryListName" placeholder="My Shopping List" style="width: 100%; padding: 10px; background: #0a0a0a; border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 14px;" />
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #00ff88; margin-bottom: 5px; font-family: monospace; font-size: 14px;">Items:</label>
                        <div id="groceryItems" style="margin-bottom: 10px;">
                            <div class="grocery-item" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" placeholder="Item name" class="item-name" style="flex: 2; padding: 8px; background: #0a0a0a; border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                                <input type="text" placeholder="Qty" class="item-qty" style="flex: 1; padding: 8px; background: #0a0a0a; border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                                <button onclick="this.parentElement.remove()" style="padding: 8px 12px; background: rgba(255, 0, 85, 0.1); border: 2px solid #ff0055; border-radius: 6px; color: #ff0055; cursor: pointer;">✕</button>
                            </div>
                        </div>
                        <button onclick="addGroceryItem()" style="width: 100%; padding: 10px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                            ➕ Add Item
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: #00ff88; margin-bottom: 10px; font-family: monospace; font-size: 14px;">Send via:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="createAndSendGroceryList('email')" style="padding: 12px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px; cursor: pointer; transition: all 0.3s;">
                                📧 Email
                            </button>
                            <button onclick="createAndSendGroceryList('sms')" style="padding: 12px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px; cursor: pointer; transition: all 0.3s;">
                                💬 SMS/Text
                            </button>
                            <button onclick="createAndSendGroceryList('download')" style="padding: 12px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px; cursor: pointer; transition: all 0.3s;">
                                💾 Download
                            </button>
                            <button onclick="createAndSendGroceryList('share')" style="padding: 12px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px; cursor: pointer; transition: all 0.3s;">
                                🔗 Share Link
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="createAndSendGroceryList('save')" style="flex: 1; padding: 12px; background: rgba(0, 255, 136, 0.2); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; font-weight: bold;">
                            💾 Save Only
                        </button>
                        <button onclick="closeGroceryListModal()" style="flex: 1; padding: 12px; background: rgba(255, 0, 85, 0.1); border: 2px solid #ff0055; border-radius: 8px; color: #ff0055; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                            ✕ Cancel
                        </button>
                    </div>
                    
                    <div id="groceryListStatus" style="margin-top: 15px; padding: 10px; background: rgba(0, 255, 136, 0.05); border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 12px; display: none;"></div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function addGroceryItem() {
            const container = document.getElementById('groceryItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'grocery-item';
            itemDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Item name" class="item-name" style="flex: 2; padding: 8px; background: #0a0a0a; border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                <input type="text" placeholder="Qty" class="item-qty" style="flex: 1; padding: 8px; background: #0a0a0a; border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                <button onclick="this.parentElement.remove()" style="padding: 8px 12px; background: rgba(255, 0, 85, 0.1); border: 2px solid #ff0055; border-radius: 6px; color: #ff0055; cursor: pointer;">✕</button>
            `;
            container.appendChild(itemDiv);
        }

        async function createAndSendGroceryList(method) {
            const listName = document.getElementById('groceryListName').value || `Shopping List ${new Date().toLocaleDateString()}`;
            const itemElements = document.querySelectorAll('.grocery-item');
            const items = [];

            itemElements.forEach(el => {
                const name = el.querySelector('.item-name').value.trim();
                const qty = el.querySelector('.item-qty').value.trim();
                if (name) {
                    items.push({ name, quantity: qty || '1' });
                }
            });

            if (items.length === 0) {
                showGroceryStatus('⚠️ Please add at least one item', 'warning');
                return;
            }

            const statusDiv = document.getElementById('groceryListStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = `Processing...`;
            statusDiv.style.color = '#00ff88';

            try {
                const response = await fetch(API_BASE_URL + '/api/grocery-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({
                        name: listName,
                        items: items,
                        method: method
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    if (method === 'download') {
                        // Download the file
                        const blob = new Blob([data.content], { type: 'text/plain' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${listName.replace(/\s+/g, '_')}.txt`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showGroceryStatus('✅ List downloaded!', 'success');
                    } else if (method === 'share') {
                        // Copy link to clipboard
                        if (data.share_link) {
                            await navigator.clipboard.writeText(data.share_link);
                            showGroceryStatus('✅ Link copied to clipboard!', 'success');
                        }
                    } else {
                        showGroceryStatus(`✅ ${data.message}`, 'success');
                    }

                    setTimeout(() => {
                        if (method !== 'save') {
                            closeGroceryListModal();
                        }
                    }, 2000);
                } else {
                    showGroceryStatus(`❌ Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showGroceryStatus(`❌ Error: ${error.message}`, 'error');
            }
        }

        function showGroceryStatus(message, type) {
            const statusDiv = document.getElementById('groceryListStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'error' ? '#ff0055' : type === 'warning' ? '#FFC107' : '#00ff88';
        }

        function closeGroceryListModal() {
            const modal = document.getElementById('groceryListModal');
            if (modal) {
                modal.remove();
            }
        }

        // Finance Modal Functions
        function showSetBudgetModal() {
            const modal = document.createElement('div');
            modal.id = 'setBudgetModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; color: #00ff88; font-family: monospace;">
                    <h3 style="margin-top: 0; color: #00ff88; font-size: 20px;">💰 Set Monthly Budget</h3>
                    <p style="color: #ccc; font-size: 13px; margin-bottom: 20px;">Set spending limits for different categories</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Category:</label>
                        <select id="budgetCategory" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;">
                            <option value="groceries">🛒 Groceries</option>
                            <option value="utilities">⚡ Utilities</option>
                            <option value="transportation">🚗 Transportation</option>
                            <option value="entertainment">🎬 Entertainment</option>
                            <option value="healthcare">🏥 Healthcare</option>
                            <option value="dining">🍴 Dining</option>
                            <option value="shopping">🛍️ Shopping</option>
                            <option value="other">📦 Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Monthly Limit ($):</label>
                        <input type="number" id="budgetAmount" placeholder="500.00" step="0.01" min="0" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeSetBudgetModal()" style="padding: 10px 20px; background: rgba(244, 67, 54, 0.1); border: 2px solid #f44336; border-radius: 6px; color: #f44336; font-family: monospace; cursor: pointer;">Cancel</button>
                        <button onclick="createBudget()" style="padding: 10px 20px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; cursor: pointer; font-weight: bold;">Set Budget</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeSetBudgetModal() {
            const modal = document.getElementById('setBudgetModal');
            if (modal) modal.remove();
        }

        async function createBudget() {
            const category = document.getElementById('budgetCategory').value;
            const amount = document.getElementById('budgetAmount').value;

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid budget amount');
                return;
            }

            const query = `set budget ${category} ${amount}`;
            closeSetBudgetModal();

            const response = document.getElementById('chatResponse');
            response.textContent = 'Setting budget...';

            try {
                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }
                const pluginResponse = data.answer || data;

                if (typeof pluginResponse === 'string') {
                    response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(pluginResponse)}</div>`;
                } else if (pluginResponse.content) {
                    if (typeof pluginResponse.content === 'object') {
                        renderStructuredData(pluginResponse);
                    } else {
                        response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(String(pluginResponse.content))}</div>`;
                    }
                } else {
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #1a1a1a; padding: 15px; border-radius: 6px; color: #ccc;">${escapeHtmlGlobal(JSON.stringify(pluginResponse, null, 2))}</pre>`;
                }
            } catch (error) {
                response.innerHTML = `<div style="color: #f44336; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #f44336;">❌ Error: ${escapeHtmlGlobal(error.message)}</div>`;
            }
        }

        function showAddGoalModal() {
            const modal = document.createElement('div');
            modal.id = 'addGoalModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; color: #00ff88; font-family: monospace;">
                    <h3 style="margin-top: 0; color: #00ff88; font-size: 20px;">🎯 Add Financial Goal</h3>
                    <p style="color: #ccc; font-size: 13px; margin-bottom: 20px;">Set a savings goal and track your progress</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Goal Name:</label>
                        <input type="text" id="goalName" placeholder="Emergency Fund" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Target Amount ($):</label>
                        <input type="number" id="goalTarget" placeholder="5000.00" step="0.01" min="0" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Current Progress ($):</label>
                        <input type="number" id="goalProgress" placeholder="0.00" step="0.01" min="0" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Target Date:</label>
                        <input type="date" id="goalDate" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeAddGoalModal()" style="padding: 10px 20px; background: rgba(244, 67, 54, 0.1); border: 2px solid #f44336; border-radius: 6px; color: #f44336; font-family: monospace; cursor: pointer;">Cancel</button>
                        <button onclick="createGoal()" style="padding: 10px 20px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; cursor: pointer; font-weight: bold;">Add Goal</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeAddGoalModal() {
            const modal = document.getElementById('addGoalModal');
            if (modal) modal.remove();
        }

        async function createGoal() {
            const name = document.getElementById('goalName').value;
            const target = document.getElementById('goalTarget').value;
            const progress = document.getElementById('goalProgress').value || '0';
            const date = document.getElementById('goalDate').value;

            if (!name || !target || parseFloat(target) <= 0) {
                alert('Please enter a valid goal name and target amount');
                return;
            }

            const query = `add goal ${name} target ${target} progress ${progress}${date ? ' by ' + date : ''}`;
            closeAddGoalModal();

            const response = document.getElementById('chatResponse');
            response.textContent = 'Adding goal...';

            try {
                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }
                const pluginResponse = data.answer || data;

                if (typeof pluginResponse === 'string') {
                    response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(pluginResponse)}</div>`;
                } else if (pluginResponse.content) {
                    if (typeof pluginResponse.content === 'object') {
                        renderStructuredData(pluginResponse);
                    } else {
                        response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(String(pluginResponse.content))}</div>`;
                    }
                } else {
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #1a1a1a; padding: 15px; border-radius: 6px; color: #ccc;">${escapeHtmlGlobal(JSON.stringify(pluginResponse, null, 2))}</pre>`;
                }
            } catch (error) {
                response.innerHTML = `<div style="color: #f44336; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #f44336;">❌ Error: ${escapeHtmlGlobal(error.message)}</div>`;
            }
        }

        function showAddTransactionModal() {
            const modal = document.createElement('div');
            modal.id = 'addTransactionModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; color: #00ff88; font-family: monospace;">
                    <h3 style="margin-top: 0; color: #00ff88; font-size: 20px;">💳 Add Transaction</h3>
                    <p style="color: #ccc; font-size: 13px; margin-bottom: 20px;">Log a new income or expense transaction</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Type:</label>
                        <select id="transactionType" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;">
                            <option value="expense">💸 Expense</option>
                            <option value="income">💰 Income</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Category:</label>
                        <select id="transactionCategory" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;">
                            <option value="groceries">🛒 Groceries</option>
                            <option value="utilities">⚡ Utilities</option>
                            <option value="transportation">🚗 Transportation</option>
                            <option value="entertainment">🎬 Entertainment</option>
                            <option value="healthcare">🏥 Healthcare</option>
                            <option value="dining">🍴 Dining</option>
                            <option value="shopping">🛍️ Shopping</option>
                            <option value="salary">💼 Salary</option>
                            <option value="freelance">🖥️ Freelance</option>
                            <option value="investment">📈 Investment</option>
                            <option value="other">📦 Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Amount ($):</label>
                        <input type="number" id="transactionAmount" placeholder="50.00" step="0.01" min="0" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Description:</label>
                        <input type="text" id="transactionDescription" placeholder="Weekly groceries" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Date:</label>
                        <input type="date" id="transactionDate" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;" />
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeAddTransactionModal()" style="padding: 10px 20px; background: rgba(244, 67, 54, 0.1); border: 2px solid #f44336; border-radius: 6px; color: #f44336; font-family: monospace; cursor: pointer;">Cancel</button>
                        <button onclick="createTransaction()" style="padding: 10px 20px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; cursor: pointer; font-weight: bold;">Add Transaction</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            // Set today's date as default
            document.getElementById('transactionDate').valueAsDate = new Date();
        }

        function closeAddTransactionModal() {
            const modal = document.getElementById('addTransactionModal');
            if (modal) modal.remove();
        }

        async function createTransaction() {
            const type = document.getElementById('transactionType').value;
            const category = document.getElementById('transactionCategory').value;
            const amount = document.getElementById('transactionAmount').value;
            const description = document.getElementById('transactionDescription').value;
            const date = document.getElementById('transactionDate').value;

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid transaction amount');
                return;
            }

            const query = `add ${type} ${category} ${amount}${description ? ' ' + description : ''}${date ? ' on ' + date : ''}`;
            closeAddTransactionModal();

            const response = document.getElementById('chatResponse');
            response.textContent = 'Adding transaction...';

            try {
                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }
                const pluginResponse = data.answer || data;

                if (typeof pluginResponse === 'string') {
                    response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(pluginResponse)}</div>`;
                } else if (pluginResponse.content) {
                    if (typeof pluginResponse.content === 'object') {
                        renderStructuredData(pluginResponse);
                    } else {
                        response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(String(pluginResponse.content))}</div>`;
                    }
                } else {
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #1a1a1a; padding: 15px; border-radius: 6px; color: #ccc;">${escapeHtmlGlobal(JSON.stringify(pluginResponse, null, 2))}</pre>`;
                }
            } catch (error) {
                response.innerHTML = `<div style="color: #f44336; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #f44336;">❌ Error: ${escapeHtmlGlobal(error.message)}</div>`;
            }
        }

        function showSpendingAnalysisModal() {
            const modal = document.createElement('div');
            modal.id = 'spendingAnalysisModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; color: #00ff88; font-family: monospace;">
                    <h3 style="margin-top: 0; color: #00ff88; font-size: 20px;">📊 Spending Analysis</h3>
                    <p style="color: #ccc; font-size: 13px; margin-bottom: 20px;">View spending patterns and insights</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Time Period:</label>
                        <select id="analysisPeriod" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;">
                            <option value="week">📅 Last 7 Days</option>
                            <option value="month" selected>📅 Last 30 Days</option>
                            <option value="quarter">📅 Last 90 Days</option>
                            <option value="year">📅 Last Year</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #00ff88; font-size: 13px;">Category Filter (Optional):</label>
                        <select id="analysisCategory" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; font-size: 13px;">
                            <option value="">All Categories</option>
                            <option value="groceries">🛒 Groceries</option>
                            <option value="utilities">⚡ Utilities</option>
                            <option value="transportation">🚗 Transportation</option>
                            <option value="entertainment">🎬 Entertainment</option>
                            <option value="healthcare">🏥 Healthcare</option>
                            <option value="dining">🍴 Dining</option>
                            <option value="shopping">🛍️ Shopping</option>
                            <option value="other">📦 Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; color: #00ff88; font-size: 13px; cursor: pointer;">
                            <input type="checkbox" id="includeGoals" checked style="width: 18px; height: 18px;" />
                            Include goal progress in report
                        </label>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; color: #00ff88; font-size: 13px; cursor: pointer;">
                            <input type="checkbox" id="downloadReport" checked style="width: 18px; height: 18px;" />
                            Generate downloadable report
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeSpendingAnalysisModal()" style="padding: 10px 20px; background: rgba(244, 67, 54, 0.1); border: 2px solid #f44336; border-radius: 6px; color: #f44336; font-family: monospace; cursor: pointer;">Cancel</button>
                        <button onclick="generateSpendingAnalysis()" style="padding: 10px 20px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 6px; color: #00ff88; font-family: monospace; cursor: pointer; font-weight: bold;">Generate Report</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeSpendingAnalysisModal() {
            const modal = document.getElementById('spendingAnalysisModal');
            if (modal) modal.remove();
        }

        async function generateSpendingAnalysis() {
            const period = document.getElementById('analysisPeriod').value;
            const category = document.getElementById('analysisCategory').value;
            const includeGoals = document.getElementById('includeGoals').checked;
            const downloadReport = document.getElementById('downloadReport').checked;

            let query = `analyze spending ${period}`;
            if (category) query += ` category ${category}`;
            if (includeGoals) query += ` with goals`;

            closeSpendingAnalysisModal();

            const response = document.getElementById('chatResponse');
            response.textContent = 'Generating spending analysis...';

            try {
                const result = await fetch(API_BASE_URL + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'kilo-dev-key-2025'
                    },
                    body: JSON.stringify({ query })
                });

                let data;
                const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                if (resultContentType && resultContentType.includes('application/json')) {
                    data = await result.json();
                } else {
                    const text = await result.text();
                    data = { answer: text };
                }
                const pluginResponse = data.answer || data;

                if (typeof pluginResponse === 'string') {
                    response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(pluginResponse)}</div>`;
                } else if (pluginResponse.content) {
                    if (typeof pluginResponse.content === 'object') {
                        renderStructuredData(pluginResponse);

                        // If download report is enabled, generate a downloadable document
                        if (downloadReport) {
                            setTimeout(() => generateFinanceReport(pluginResponse.content, period, category), 500);
                        }
                    } else {
                        response.innerHTML = `<div style="color: #4CAF50; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">${escapeHtmlGlobal(String(pluginResponse.content))}</div>`;
                    }
                } else {
                    response.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #1a1a1a; padding: 15px; border-radius: 6px; color: #ccc;">${escapeHtmlGlobal(JSON.stringify(pluginResponse, null, 2))}</pre>`;
                }
            } catch (error) {
                response.innerHTML = `<div style="color: #f44336; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #f44336;">❌ Error: ${escapeHtmlGlobal(error.message)}</div>`;
            }
        }

        function generateFinanceReport(data, period, category) {
            let reportText = '=== KILO GUARDIAN FINANCE REPORT ===\n\n';
            reportText += `Period: ${period}\n`;
            if (category) reportText += `Category: ${category}\n`;
            reportText += `Generated: ${new Date().toLocaleString()}\n\n`;
            reportText += '---\n\n';

            if (typeof data === 'object') {
                reportText += JSON.stringify(data, null, 2);
            } else {
                reportText += data;
            }

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            const response = document.getElementById('chatResponse');
            const downloadMsg = document.createElement('div');
            downloadMsg.style.cssText = 'color: #00ff88; padding: 10px; background: rgba(0, 255, 136, 0.1); border-radius: 6px; margin-top: 10px; border-left: 3px solid #00ff88;';
            downloadMsg.textContent = '✅ Report downloaded successfully!';
            response.appendChild(downloadMsg);
        }

        // Show upload documents modal
        function showUploadModal() {
            const modal = document.createElement('div');
            modal.id = 'uploadModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: #0a0a0a; border: 2px solid #00ff88; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);">
                    <h2 style="margin: 0 0 20px 0; color: #00ff88; text-align: center; font-size: 24px;">📤 Upload Documents</h2>
                    <p style="color: #888; text-align: center; margin-bottom: 25px; font-size: 14px;">Choose document type to upload</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="handleUpload('csv'); closeUploadModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-csv" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Banking CSV</div>
                                <div style="font-size: 11px; color: #666;">Upload bank statement CSV file</div>
                            </div>
                        </button>
                        
                        <button onclick="handleUpload('receipt'); closeUploadModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-receipt" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Receipt</div>
                                <div style="font-size: 11px; color: #666;">Upload receipt image or PDF</div>
                            </div>
                        </button>
                        
                        <button onclick="handleUpload('bill'); closeUploadModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-invoice" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Bill / Invoice</div>
                                <div style="font-size: 11px; color: #666;">Upload utility bill or invoice</div>
                            </div>
                        </button>
                        
                        <button onclick="handleUpload('document'); closeUploadModal();" style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; color: #00ff88; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-alt" style="font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: bold;">Financial Document</div>
                                <div style="font-size: 11px; color: #666;">Upload any financial document</div>
                            </div>
                        </button>
                    </div>
                    
                    <button onclick="closeUploadModal()" style="width: 100%; margin-top: 20px; padding: 12px; background: rgba(255, 0, 85, 0.1); border: 2px solid #ff0055; border-radius: 8px; color: #ff0055; font-family: monospace; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                        ✕ Cancel
                    </button>
                </div>
            `;

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUploadModal();
                }
            });

            document.body.appendChild(modal);
        }

        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            if (modal) {
                modal.remove();
            }
        }

        // Render life tracking data
        function renderLifeTracking(data) {
            const response = document.getElementById('chatResponse');
            const content = data.content || data;

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            function renderValue(value) {
                if (typeof value === 'object' && !Array.isArray(value)) {
                    let objHtml = '<div style="margin-left: 15px; border-left: 2px solid #555; padding-left: 10px;">';
                    Object.entries(value).forEach(([k, v]) => {
                        objHtml += `<div style="margin: 5px 0;"><span style="color: #81C784; font-weight: bold;">${escapeHtml(k)}:</span> <span style="color: #ccc;">${escapeHtml(String(v))}</span></div>`;
                    });
                    objHtml += '</div>';
                    return objHtml;
                } else if (Array.isArray(value)) {
                    return value.map(v => escapeHtml(String(v))).join(', ');
                } else {
                    return escapeHtml(String(value));
                }
            }

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        ❤️ ${escapeHtml(content.message || 'Life Tracking Summary')}
                    </h2>
            `;

            // Description if present
            if (content.description) {
                html += `<div style="padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50; color: #aaa; margin-bottom: 15px;">${escapeHtml(content.description)}</div>`;
            }

            // Commands section
            if (content.commands && Array.isArray(content.commands)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">📝 Available Commands</h3>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ccc; list-style: none;">
                `;
                content.commands.forEach(cmd => {
                    html += `<li style="margin: 8px 0; font-family: monospace; color: #81C784;">→ ${escapeHtml(cmd)}</li>`;
                });
                html += '</ul></div>';
            }

            // Monitoring section (nested object)
            if (content.monitoring && typeof content.monitoring === 'object') {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #2196F3;">
                        <h3 style="margin: 0 0 10px 0; color: #2196F3; font-size: 16px;">📹 Monitoring</h3>
                `;
                Object.entries(content.monitoring).forEach(([key, value]) => {
                    html += `<div style="margin: 8px 0; color: #ccc;"><strong style="color: #64B5F6;">${escapeHtml(key.replace(/_/g, ' '))}:</strong> ${renderValue(value)}</div>`;
                });
                html += '</div>';
            }

            // Features section
            if (content.features && Array.isArray(content.features)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #9C27B0;">
                        <h3 style="margin: 0 0 10px 0; color: #9C27B0; font-size: 16px;">✨ Features</h3>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ccc; list-style: none;">
                `;
                content.features.forEach(feature => {
                    html += `<li style="margin: 8px 0;">${escapeHtml(feature)}</li>`;
                });
                html += '</ul></div>';
            }

            // Activity status
            if (content.current_session || content.activity) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #FF9800;">
                        <h3 style="margin: 0 0 10px 0; color: #FF9800; font-size: 16px;">🏃 Activity Status</h3>
                `;
                if (content.current_session) {
                    Object.entries(content.current_session).forEach(([key, value]) => {
                        html += `<div style="margin: 8px 0; color: #ccc;"><strong style="color: #FFB74D;">${escapeHtml(key.replace(/_/g, ' '))}:</strong> ${renderValue(value)}</div>`;
                    });
                }
                if (content.activity) {
                    Object.entries(content.activity).forEach(([key, value]) => {
                        html += `<div style="margin: 8px 0; color: #ccc;"><strong style="color: #FFB74D;">${escapeHtml(key.replace(/_/g, ' '))}:</strong> ${renderValue(value)}</div>`;
                    });
                }
                if (content.today_summary) {
                    html += '<div style="margin-top: 10px; padding: 10px; background: rgba(255, 152, 0, 0.1); border-radius: 4px;">';
                    html += '<strong style="color: #FF9800;">Today\'s Progress:</strong><br>';
                    Object.entries(content.today_summary).forEach(([key, value]) => {
                        html += `<div style="margin: 5px 0; color: #ccc;">${escapeHtml(key.replace(/_/g, ' '))}: <span style="color: #FFB74D; font-weight: bold;">${escapeHtml(String(value))}</span></div>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
            }

            // Wellness summary
            if (content.wellness_score !== undefined || content.status) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">💚 Wellness</h3>
                `;
                if (content.wellness_score !== undefined) {
                    html += `<div style="margin: 10px 0;"><strong style="color: #4CAF50;">Score:</strong> <span style="font-size: 24px; font-weight: bold; color: #81C784;">${content.wellness_score}/100</span></div>`;
                }
                if (content.status) {
                    html += `<div style="margin: 10px 0;"><strong style="color: #4CAF50;">Status:</strong> <span style="color: #ccc;">${escapeHtml(content.status)}</span></div>`;
                }
                html += '</div>';
            }

            // Reminders list
            if (content.reminders && Array.isArray(content.reminders)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #FF5722;">
                        <h3 style="margin: 0 0 10px 0; color: #FF5722; font-size: 16px;">⏰ Reminders (${content.reminders.length})</h3>
                `;
                if (content.reminders.length === 0) {
                    html += '<p style="color: #666; font-style: italic;">No active reminders</p>';
                } else {
                    content.reminders.forEach((reminder, idx) => {
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255, 87, 34, 0.1); border-radius: 4px; border-left: 2px solid #FF5722;">
                                <div style="color: #FF8A65; font-weight: bold; margin-bottom: 5px;">${escapeHtml(reminder.message || reminder.name || `Reminder ${idx + 1}`)}</div>
                                <div style="font-size: 11px; color: #999;">Type: ${escapeHtml(reminder.type || 'N/A')} | Frequency: ${escapeHtml(reminder.frequency || 'N/A')}</div>
                            </div>
                        `;
                    });
                }
                html += '</div>';
            }

            // Tasks list
            if (content.tasks && Array.isArray(content.tasks)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #00BCD4;">
                        <h3 style="margin: 0 0 10px 0; color: #00BCD4; font-size: 16px;">✅ Tasks (${content.tasks.length})</h3>
                `;
                if (content.tasks.length === 0) {
                    html += '<p style="color: #666; font-style: italic;">No pending tasks</p>';
                } else {
                    content.tasks.forEach((task, idx) => {
                        const priorityColor = task.priority === 'high' ? '#f44336' : task.priority === 'medium' ? '#FF9800' : '#4CAF50';
                        html += `
                            <div style="margin: 10px 0; padding: 10px; background: rgba(0, 188, 212, 0.1); border-radius: 4px; border-left: 2px solid ${priorityColor};">
                                <div style="color: #4DD0E1; font-weight: bold; margin-bottom: 5px;">${escapeHtml(task.name || task.task_name || `Task ${idx + 1}`)}</div>
                                <div style="font-size: 11px; color: #999;">Category: ${escapeHtml(task.category || 'N/A')} | Priority: ${escapeHtml(task.priority || 'medium')}</div>
                            </div>
                        `;
                    });
                }
                html += '</div>';
            }

            // Suggestions (AI suggestions)
            if (content.suggestions && Array.isArray(content.suggestions)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #9C27B0;">
                        <h3 style="margin: 0 0 10px 0; color: #9C27B0; font-size: 16px;">🤖 AI Suggestions</h3>
                `;
                content.suggestions.forEach((suggestion, idx) => {
                    const priorityColor = suggestion.priority === 'high' ? '#f44336' : suggestion.priority === 'medium' ? '#FF9800' : '#4CAF50';
                    html += `
                        <div style="margin: 10px 0; padding: 12px; background: rgba(156, 39, 176, 0.1); border-radius: 4px; border-left: 2px solid ${priorityColor};">
                            <div style="color: #BA68C8; font-weight: bold; margin-bottom: 5px;">${escapeHtml(suggestion.task || suggestion.name || `Suggestion ${idx + 1}`)}</div>
                            ${suggestion.reason ? `<div style="font-size: 12px; color: #aaa; margin: 5px 0; font-style: italic;">${escapeHtml(suggestion.reason)}</div>` : ''}
                            <div style="font-size: 11px; color: #999;">Category: ${escapeHtml(suggestion.category || 'N/A')} | Priority: <span style="color: ${priorityColor}; font-weight: bold;">${escapeHtml(suggestion.priority || 'medium')}</span></div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Feedback messages (arrays of strings)
            if (content.feedback && Array.isArray(content.feedback)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #FF9800;">
                        <h3 style="margin: 0 0 10px 0; color: #FF9800; font-size: 16px;">💬 Feedback</h3>
                `;
                content.feedback.forEach(msg => {
                    html += `<div style="margin: 8px 0; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; color: #FFB74D;">${escapeHtml(msg)}</div>`;
                });
                html += '</div>';
            }

            // Recommendations
            if (content.recommendations && Array.isArray(content.recommendations)) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">💡 Recommendations</h3>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ccc; list-style: none;">
                `;
                content.recommendations.forEach(rec => {
                    html += `<li style="margin: 8px 0; color: #81C784;">✓ ${escapeHtml(rec)}</li>`;
                });
                html += '</ul></div>';
            }

            // Stats (generic key-value pairs)
            if (content.stats && typeof content.stats === 'object') {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #00BCD4;">
                        <h3 style="margin: 0 0 10px 0; color: #00BCD4; font-size: 16px;">📊 Statistics</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #ccc;">
                `;
                Object.entries(content.stats).forEach(([key, value]) => {
                    html += `
                        <div style="background: rgba(0, 188, 212, 0.1); padding: 10px; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase;">${escapeHtml(key.replace(/_/g, ' '))}</div>
                            <div style="font-size: 18px; font-weight: bold; margin-top: 5px; color: #4DD0E1;">${escapeHtml(String(value))}</div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Note if present
            if (content.note) {
                html += `<div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 4px; border-left: 2px solid #FFC107; color: #FFD54F; font-size: 12px; font-style: italic;">${escapeHtml(content.note)}</div>`;
            }

            html += '</div>';
            response.innerHTML = html;
        }

        // Render structured data generically
        function renderStructuredData(data) {
            const response = document.getElementById('chatResponse');
            const content = data.content || {};

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        ${escapeHtml(data.tool || 'Response')}
                    </h2>
            `;

            // Render content object nicely
            if (typeof content === 'object' && !Array.isArray(content)) {
                Object.entries(content).forEach(([key, value]) => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">
                            <h3 style="margin: 0 0 8px 0; color: #4CAF50; font-size: 14px; text-transform: capitalize;">${escapeHtml(key)}</h3>
                    `;

                    // Budgets table
                    if (key === 'budgets' && Array.isArray(value)) {
                        html += `<table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;">
                            <thead>
                                <tr style="background:#222; color:#4CAF50;">
                                    <th>Category</th><th>Limit</th><th>Spent</th><th>Remaining</th><th>% Used</th><th>Status</th>
                                </tr>
                            </thead><tbody>`;
                        value.forEach(budget => {
                            html += `<tr style="background:#181818; color:#ccc;">
                                <td>${escapeHtml(budget.category)}</td>
                                <td>${escapeHtml(budget.limit)}</td>
                                <td>${escapeHtml(budget.spent)}</td>
                                <td>${escapeHtml(budget.remaining)}</td>
                                <td>${escapeHtml(budget.percentage.toFixed(1))}%</td>
                                <td style="color:${budget.status === 'over' ? '#f44336' : budget.status === 'warning' ? '#FFC107' : '#4CAF50'}; font-weight:bold;">${escapeHtml(budget.status)}</td>
                            </tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    // Spending analysis by category
                    else if (key === 'by_category' && Array.isArray(value)) {
                        html += `<table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;">
                            <thead><tr style="background:#222; color:#4CAF50;"><th>Category</th><th>Total</th><th>Count</th></tr></thead><tbody>`;
                        value.forEach(row => {
                            html += `<tr style="background:#181818; color:#ccc;"><td>${escapeHtml(row.category)}</td><td>${escapeHtml(row.total)}</td><td>${escapeHtml(row.count)}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    // Monthly trend
                    else if (key === 'monthly_trend' && Array.isArray(value)) {
                        html += `<table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;">
                            <thead><tr style="background:#222; color:#4CAF50;"><th>Month</th><th>Total</th></tr></thead><tbody>`;
                        value.forEach(row => {
                            html += `<tr style="background:#181818; color:#ccc;"><td>${escapeHtml(row.month)}</td><td>${escapeHtml(row.total)}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    // Goals table
                    else if (key === 'goals' && Array.isArray(value)) {
                        html += `<table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;">
                            <thead><tr style="background:#222; color:#4CAF50;"><th>Name</th><th>Target</th><th>Current</th><th>Progress</th><th>Remaining</th><th>Days Left</th><th>Priority</th><th>Status</th></tr></thead><tbody>`;
                        value.forEach(goal => {
                            html += `<tr style="background:#181818; color:#ccc;"><td>${escapeHtml(goal.name)}</td><td>${escapeHtml(goal.target)}</td><td>${escapeHtml(goal.current)}</td><td>${escapeHtml(goal.progress.toFixed(1))}%</td><td>${escapeHtml(goal.remaining)}</td><td>${escapeHtml(goal.days_left)}</td><td>${escapeHtml(goal.priority)}</td><td>${escapeHtml(goal.status)}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    // Grocery lists
                    else if (key === 'lists' && Array.isArray(value)) {
                        html += `<ul style="margin:0; padding-left:20px; color:#ccc;">`;
                        value.forEach(list => {
                            html += `<li><b>${escapeHtml(list.name)}</b> (${escapeHtml(list.created)}) ${list.completed ? '<span style=\'color:#4CAF50\'>✔️ Completed</span>' : '<span style=\'color:#FFC107\'>⏳ Pending</span>'}</li>`;
                        });
                        html += '</ul>';
                    }
                    // Financial advice
                    else if (key === 'advice' && Array.isArray(value)) {
                        html += `<ul style="margin:0; padding-left:20px; color:#ccc;">`;
                        value.forEach(advice => {
                            html += `<li><span style="font-weight:bold; color:${advice.priority === 'high' ? '#f44336' : advice.priority === 'medium' ? '#FFC107' : '#4CAF50'};">${escapeHtml(advice.priority)}</span>: ${escapeHtml(advice.message)}</li>`;
                        });
                        html += '</ul>';
                    }
                    // Default: pretty print object or value
                    else if (typeof value === 'object') {
                        html += `<pre style="margin: 0; color: #ccc; white-space: pre-wrap; font-family: monospace; font-size: 12px;">${escapeHtml(JSON.stringify(value, null, 2))}</pre>`;
                    } else {
                        html += `<div style="color: #ccc;">${escapeHtml(String(value))}</div>`;
                    }

                    html += '</div>';
                });
            } else if (Array.isArray(content)) {
                html += '<ul style="margin: 0; padding-left: 20px; color: #ccc;">';
                content.forEach(item => {
                    html += `<li style="margin: 8px 0;">${escapeHtml(String(item))}</li>`;
                });
                html += '</ul>';
            } else {
                html += `<div style="padding: 15px; background: #1a1a1a; border-radius: 6px; color: #ccc;">${escapeHtml(String(content))}</div>`;
            }

            html += '</div>';
            response.innerHTML = html;
        }

        function renderFinanceHelp(data) {
            const response = document.getElementById('chatResponse');
            const content = data.content || {};

            // Helper function to safely escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        💰 ${escapeHtml(content.message || 'Finance Manager')}
                    </h2>
            `;

            // Commands section
            if (content.commands && content.commands.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #4CAF50;">
                        <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;">📝 Available Commands</h3>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ccc; list-style: none;">
                `;
                content.commands.forEach(cmd => {
                    html += `<li style="margin: 8px 0; font-family: monospace; color: #81C784;">→ ${escapeHtml(cmd)}</li>`;
                });
                html += '</ul></div>';
            }

            // Features section
            if (content.features && content.features.length > 0) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #2196F3;">
                        <h3 style="margin: 0 0 10px 0; color: #2196F3; font-size: 16px;">✨ Features</h3>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #ccc; list-style: none;">
                `;
                content.features.forEach(feature => {
                    html += `<li style="margin: 8px 0;">${escapeHtml(feature)}</li>`;
                });
                html += '</ul></div>';
            }

            html += '</div>';
            response.innerHTML = html;
        }

        // Finance Manager Renderers with Export Functionality
        function renderFinanceResponse(data) {
            const response = document.getElementById('chatResponse');

            // Route to specific renderer based on type
            switch (data.type) {
                case 'budget_status':
                    renderBudgetStatus(data);
                    break;
                case 'spending_analysis':
                    renderSpendingAnalysis(data);
                    break;
                case 'spending_summary':
                    renderSpendingSummary(data);
                    break;
                case 'goals_status':
                    renderGoalsStatus(data);
                    break;
                case 'grocery_lists':
                    renderGroceryLists(data);
                    break;
                case 'financial_advice':
                    renderFinancialAdvice(data);
                    break;
                case 'financial_overview':
                    renderFinancialOverview(data);
                    break;
                default:
                    // Fallback to structured data renderer
                    renderStructuredData(data);
            }
        }

        function createExportButtons(dataObj, title) {
            return `
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                    <button onclick='exportToPrint(${JSON.stringify(dataObj).replace(/'/g, "\\'")} , "${title}")' 
                            style="background: #2196F3; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button onclick='exportToEmail(${JSON.stringify(dataObj).replace(/'/g, "\\'")} , "${title}")' 
                            style="background: #4CAF50; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        <i class="fas fa-envelope"></i> Email
                    </button>
                    <button onclick='exportToText(${JSON.stringify(dataObj).replace(/'/g, "\\'")} , "${title}")' 
                            style="background: #FF9800; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        <i class="fas fa-sms"></i> Text
                    </button>
                    <button onclick='copyToClipboard(${JSON.stringify(dataObj).replace(/'/g, "\\'")} , "${title}")' 
                            style="background: #9C27B0; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            `;
        }

        function renderBudgetStatus(data) {
            const response = document.getElementById('chatResponse');
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            const budgets = data.budgets || [];
            const summary = data.summary || {};

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        💰 Budget Status Report
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #1a1a1a; border: 1px solid #4CAF50; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TOTAL BUDGETED</div>
                            <div style="color: #4CAF50; font-size: 24px; font-weight: bold;">$${summary.total_budgeted?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #FF9800; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TOTAL SPENT</div>
                            <div style="color: #FF9800; font-size: 24px; font-weight: bold;">$${summary.total_spent?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid ${summary.categories_over_budget > 0 ? '#f44336' : '#4CAF50'}; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">OVER BUDGET</div>
                            <div style="color: ${summary.categories_over_budget > 0 ? '#f44336' : '#4CAF50'}; font-size: 24px; font-weight: bold;">${summary.categories_over_budget || 0}</div>
                        </div>
                    </div>
            `;

            if (budgets.length > 0) {
                html += `
                    <h3 style="color: #4CAF50; margin: 20px 0 10px;">Category Breakdown</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: #1a1a1a; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #222; color: #4CAF50;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4CAF50;">Category</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Limit</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Spent</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Remaining</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #4CAF50;">Progress</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #4CAF50;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                budgets.forEach((budget, index) => {
                    const statusColor = budget.status === 'over' ? '#f44336' : budget.status === 'warning' ? '#FFC107' : '#4CAF50';
                    const statusIcon = budget.status === 'over' ? '🔴' : budget.status === 'warning' ? '⚠️' : '✅';
                    const bgColor = index % 2 === 0 ? '#1a1a1a' : '#151515';

                    html += `
                        <tr style="background: ${bgColor}; color: #ccc;">
                            <td style="padding: 12px; font-weight: 600;">${escapeHtml(budget.category)}</td>
                            <td style="padding: 12px; text-align: right;">$${budget.limit?.toFixed(2) || '0.00'}</td>
                            <td style="padding: 12px; text-align: right;">$${budget.spent?.toFixed(2) || '0.00'}</td>
                            <td style="padding: 12px; text-align: right; color: ${budget.remaining < 0 ? '#f44336' : '#4CAF50'};">$${budget.remaining?.toFixed(2) || '0.00'}</td>
                            <td style="padding: 12px;">
                                <div style="background: #333; border-radius: 10px; overflow: hidden; height: 20px; position: relative;">
                                    <div style="background: ${statusColor}; height: 100%; width: ${Math.min(budget.percentage || 0, 100)}%; transition: width 0.3s;"></div>
                                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff; text-shadow: 0 0 3px #000;">
                                        ${(budget.percentage || 0).toFixed(1)}%
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 12px; text-align: center; color: ${statusColor}; font-weight: bold;">
                                ${statusIcon} ${escapeHtml(budget.status.toUpperCase())}
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            } else {
                html += '<p style="color: #888; text-align: center; padding: 20px;">No budgets configured. Set up your first budget using the banking modal.</p>';
            }

            html += createExportButtons(data, 'Budget Status Report');
            html += '</div>';
            response.innerHTML = html;
        }

        function renderSpendingAnalysis(data) {
            const response = document.getElementById('chatResponse');
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            const categoryBreakdown = data.category_breakdown || [];
            const monthlyTrend = data.monthly_trend || [];
            const patterns = data.patterns || [];
            const insights = data.insights || [];

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        📊 Spending Analysis - ${escapeHtml(data.period || 'Last 3 Months')}
                    </h2>

                    <div style="background: #1a1a1a; border: 1px solid #2196F3; border-radius: 6px; padding: 15px; margin: 15px 0;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">AVERAGE TRANSACTION</div>
                        <div style="color: #2196F3; font-size: 28px; font-weight: bold;">$${data.average_transaction?.toFixed(2) || '0.00'}</div>
                    </div>
            `;

            if (patterns.length > 0) {
                html += `
                    <div style="background: #1a1a1a; border-left: 3px solid #FF9800; padding: 15px; margin: 15px 0; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px; color: #FF9800;">🔍 Spending Patterns</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #ccc;">
                `;
                patterns.forEach(pattern => {
                    html += `<li style="margin: 8px 0;">${escapeHtml(pattern)}</li>`;
                });
                html += '</ul></div>';
            }

            if (insights.length > 0) {
                html += `
                    <div style="background: #1a1a1a; border-left: 3px solid #4CAF50; padding: 15px; margin: 15px 0; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px; color: #4CAF50;">💡 Insights & Recommendations</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #ccc;">
                `;
                insights.forEach(insight => {
                    html += `<li style="margin: 8px 0;">${escapeHtml(insight)}</li>`;
                });
                html += '</ul></div>';
            }

            if (categoryBreakdown.length > 0) {
                html += `
                    <h3 style="color: #4CAF50; margin: 20px 0 10px;">Spending by Category</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: #1a1a1a; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #222; color: #4CAF50;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4CAF50;">Category</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Total Spent</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                categoryBreakdown.forEach((cat, index) => {
                    const bgColor = index % 2 === 0 ? '#1a1a1a' : '#151515';
                    html += `
                        <tr style="background: ${bgColor}; color: #ccc;">
                            <td style="padding: 12px; font-weight: 600;">${escapeHtml(cat.category)}</td>
                            <td style="padding: 12px; text-align: right; color: #FF9800; font-weight: 600;">$${cat.total?.toFixed(2) || '0.00'}</td>
                            <td style="padding: 12px; text-align: right;">${cat.transactions || 0}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            }

            if (monthlyTrend.length > 0) {
                html += `
                    <h3 style="color: #4CAF50; margin: 20px 0 10px;">Monthly Trend</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: #1a1a1a; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #222; color: #4CAF50;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4CAF50;">Month</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Total Spent</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                monthlyTrend.forEach((month, index) => {
                    const bgColor = index % 2 === 0 ? '#1a1a1a' : '#151515';
                    html += `
                        <tr style="background: ${bgColor}; color: #ccc;">
                            <td style="padding: 12px; font-weight: 600;">${escapeHtml(month.month)}</td>
                            <td style="padding: 12px; text-align: right; color: #2196F3; font-weight: 600;">$${month.total?.toFixed(2) || '0.00'}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            }

            html += createExportButtons(data, 'Spending Analysis Report');
            html += '</div>';
            response.innerHTML = html;
        }

        function renderSpendingSummary(data) {
            const response = document.getElementById('chatResponse');
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            const netStatus = data.status === 'surplus' ? '✅ Surplus' : '⚠️ Deficit';
            const netColor = data.status === 'surplus' ? '#4CAF50' : '#FF9800';

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        💵 Spending Summary - ${escapeHtml(data.period || 'Current Month')}
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #1a1a1a; border: 1px solid #4CAF50; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">INCOME</div>
                            <div style="color: #4CAF50; font-size: 24px; font-weight: bold;">$${data.total_income?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #f44336; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">EXPENSES</div>
                            <div style="color: #f44336; font-size: 24px; font-weight: bold;">$${data.total_expenses?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid ${netColor}; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">NET</div>
                            <div style="color: ${netColor}; font-size: 24px; font-weight: bold;">$${data.net?.toFixed(2) || '0.00'}</div>
                            <div style="color: ${netColor}; font-size: 11px; margin-top: 5px; font-weight: 600;">${netStatus}</div>
                        </div>
                    </div>
            `;

            if (data.top_expenses && data.top_expenses.length > 0) {
                html += `
                    <h3 style="color: #4CAF50; margin: 20px 0 10px;">Top Expenses This Month</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: #1a1a1a; border-radius: 6px; overflow: hidden;">
                            <thead>
                                <tr style="background: #222; color: #4CAF50;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4CAF50;">Date</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4CAF50;">Description</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #4CAF50;">Category</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #4CAF50;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.top_expenses.forEach((expense, index) => {
                    const bgColor = index % 2 === 0 ? '#1a1a1a' : '#151515';
                    html += `
                        <tr style="background: ${bgColor}; color: #ccc;">
                            <td style="padding: 12px;">${escapeHtml(expense.date || 'N/A')}</td>
                            <td style="padding: 12px; font-weight: 600;">${escapeHtml(expense.description || 'No description')}</td>
                            <td style="padding: 12px;">${escapeHtml(expense.category || 'Other')}</td>
                            <td style="padding: 12px; text-align: right; color: #f44336; font-weight: 600;">$${expense.amount?.toFixed(2) || '0.00'}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            }

            html += createExportButtons(data, 'Spending Summary');
            html += '</div>';
            response.innerHTML = html;
        }

        function renderGoalsStatus(data) {
            const response = document.getElementById('chatResponse');
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            const goals = data.goals || [];

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        🎯 Financial Goals Progress
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: #1a1a1a; border: 1px solid #4CAF50; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TOTAL GOALS</div>
                            <div style="color: #4CAF50; font-size: 24px; font-weight: bold;">${data.total_goals || 0}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #2196F3; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">ACTIVE GOALS</div>
                            <div style="color: #2196F3; font-size: 24px; font-weight: bold;">${data.active_goals || 0}</div>
                        </div>
                    </div>
            `;

            if (goals.length > 0) {
                goals.forEach((goal, index) => {
                    const priorityColor = goal.priority === 'high' ? '#f44336' : goal.priority === 'medium' ? '#FF9800' : '#4CAF50';
                    const statusColor = goal.status === 'on_track' ? '#4CAF50' : '#FF9800';
                    const statusIcon = goal.status === 'on_track' ? '✅' : '⏰';
                    const daysText = goal.days_remaining > 0 ? `${goal.days_remaining} days left` : 'Overdue!';

                    html += `
                        <div style="background: #1a1a1a; border: 1px solid ${priorityColor}; border-radius: 8px; padding: 20px; margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0 0 8px; color: #fff; font-size: 18px;">${escapeHtml(goal.name)}</h3>
                                    <div style="color: #888; font-size: 12px;">
                                        Priority: <span style="color: ${priorityColor}; font-weight: 600; text-transform: uppercase;">${escapeHtml(goal.priority)}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${statusColor}; font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                                        ${statusIcon} ${escapeHtml(goal.status.replace('_', ' ').toUpperCase())}
                                    </div>
                                    <div style="color: #888; font-size: 11px;">${escapeHtml(daysText)}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <div style="color: #888; font-size: 11px; margin-bottom: 4px;">TARGET</div>
                                    <div style="color: #4CAF50; font-size: 18px; font-weight: 600;">$${goal.target?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 11px; margin-bottom: 4px;">CURRENT</div>
                                    <div style="color: #2196F3; font-size: 18px; font-weight: 600;">$${goal.current?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div>
                                    <div style="color: #888; font-size: 11px; margin-bottom: 4px;">REMAINING</div>
                                    <div style="color: #FF9800; font-size: 18px; font-weight: 600;">$${goal.remaining?.toFixed(2) || '0.00'}</div>
                                </div>
                            </div>
                            
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="color: #888; font-size: 12px;">Progress</span>
                                    <span style="color: ${statusColor}; font-size: 12px; font-weight: 600;">${goal.progress?.toFixed(1) || 0}%</span>
                                </div>
                                <div style="background: #333; border-radius: 10px; overflow: hidden; height: 24px; position: relative;">
                                    <div style="background: linear-gradient(90deg, ${statusColor}, ${priorityColor}); height: 100%; width: ${Math.min(goal.progress || 0, 100)}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <div style="color: #888; font-size: 12px; margin-top: 12px;">
                                Deadline: <span style="color: #ccc; font-weight: 600;">${escapeHtml(goal.deadline || 'Not set')}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #888; text-align: center; padding: 20px;">No financial goals set. Create your first goal using the banking modal.</p>';
            }

            html += createExportButtons(data, 'Financial Goals Report');
            html += '</div>';
            response.innerHTML = html;
        }

        function renderGroceryLists(data) {
            const response = document.getElementById('chatResponse');
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            const lists = data.lists || [];

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        🛒 Grocery Lists
                    </h2>
            `;

            if (lists.length > 0) {
                lists.forEach((list, index) => {
                    const progress = list.total_items > 0 ? (list.checked_items / list.total_items * 100) : 0;
                    const statusColor = list.completed ? '#4CAF50' : progress > 50 ? '#2196F3' : '#FF9800';
                    const statusIcon = list.completed ? '✅' : progress > 50 ? '📝' : '🛒';

                    html += `
                        <div style="background: #1a1a1a; border: 1px solid ${statusColor}; border-radius: 8px; padding: 15px; margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #fff; font-size: 16px;">${statusIcon} ${escapeHtml(list.name)}</h3>
                                <div style="color: #888; font-size: 11px;">${escapeHtml(list.created || 'N/A')}</div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                <div style="color: #888; font-size: 13px;">
                                    Items: <span style="color: ${statusColor}; font-weight: 600;">${list.checked_items || 0}/${list.total_items || 0}</span>
                                </div>
                                ${list.completed ? '<div style="background: #4CAF50; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">COMPLETED</div>' : ''}
                            </div>
                            
                            <div style="background: #333; border-radius: 10px; overflow: hidden; height: 16px;">
                                <div style="background: ${statusColor}; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #888; text-align: center; padding: 20px;">No grocery lists yet. Create your first list using the banking modal.</p>';
            }

            html += createExportButtons(data, 'Grocery Lists');
            html += '</div>';
            response.innerHTML = html;
        }

        function renderFinancialAdvice(data) {
            const response = document.getElementById('chatResponse');
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            const advice = data.advice || [];

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        💡 Financial Advice & Recommendations
                    </h2>
            `;

            if (advice.length > 0) {
                advice.forEach((item, index) => {
                    const priorityColor = item.priority === 'high' ? '#f44336' : item.priority === 'medium' ? '#FF9800' : '#4CAF50';
                    const priorityIcon = item.priority === 'high' ? '🔴' : item.priority === 'medium' ? '⚠️' : '💚';

                    html += `
                        <div style="background: #1a1a1a; border-left: 4px solid ${priorityColor}; padding: 15px; margin: 12px 0; border-radius: 4px;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 24px;">${priorityIcon}</div>
                                <div style="flex: 1;">
                                    <div style="color: ${priorityColor}; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 6px;">
                                        ${escapeHtml(item.priority)} Priority - ${escapeHtml(item.category)}
                                    </div>
                                    <div style="color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                                        ${escapeHtml(item.suggestion)}
                                    </div>
                                    <div style="color: #2196F3; font-size: 12px; font-style: italic;">
                                        💡 ${escapeHtml(item.action)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #888; text-align: center; padding: 20px;">✅ No urgent financial advice at this time. Your finances look good!</p>';
            }

            html += createExportButtons(data, 'Financial Advice');
            html += '</div>';
            response.innerHTML = html;
        }

        function renderFinancialOverview(data) {
            const response = document.getElementById('chatResponse');

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.6;">
                    <h2 style="margin-top: 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                        📈 Complete Financial Overview
                    </h2>
                    <p style="color: #888; margin-bottom: 20px;">${data.message || 'Your complete financial snapshot'}</p>
                </div>
            `;

            response.innerHTML = html;

            // Render each section
            if (data.sections) {
                if (data.sections.spending) {
                    renderSpendingSummary(data.sections.spending);
                    html = response.innerHTML;
                }
                if (data.sections.budgets) {
                    const currentHtml = response.innerHTML;
                    renderBudgetStatus(data.sections.budgets);
                    response.innerHTML = currentHtml + '<div style="margin-top: 20px;"></div>' + response.innerHTML;
                }
                if (data.sections.goals) {
                    const currentHtml = response.innerHTML;
                    renderGoalsStatus(data.sections.goals);
                    response.innerHTML = currentHtml + '<div style="margin-top: 20px;"></div>' + response.innerHTML;
                }
            }
        }

        // Export Functions
        async function exportToPrint(dataObj, title) {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            const formattedData = formatDataForExport(dataObj, title);

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        h1 { color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
                        h2 { color: #2196F3; margin-top: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #f0f0f0; font-weight: bold; }
                        .summary-box { background: #f9f9f9; padding: 15px; margin: 15px 0; border-left: 4px solid #4CAF50; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="summary-box">
                        <strong>Generated:</strong> ${new Date().toLocaleString()}<br>
                        <strong>System:</strong> Kilo Guardian - Bastion AI
                    </div>
                    ${formattedData}
                    <button onclick="window.print()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;">Print</button>
                    <button onclick="window.close()" style="background: #999; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Close</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function exportToEmail(dataObj, title) {
            const formattedData = formatDataForExport(dataObj, title);
            const emailBody = encodeURIComponent(`${title}\n\nGenerated: ${new Date().toLocaleString()}\nSystem: Kilo Guardian\n\n${stripHTML(formattedData)}`);
            const subject = encodeURIComponent(title);

            // Try to open default email client
            window.location.href = `mailto:?subject=${subject}&body=${emailBody}`;

            // Show confirmation
            alert('Email client opened. If nothing happened, please check your default email settings or copy the data manually.');
        }

        async function exportToText(dataObj, title) {
            const formattedData = formatDataForExport(dataObj, title);
            const textData = stripHTML(formattedData);

            // For SMS, we need to keep it short
            const shortSummary = `${title}: ${textData.substring(0, 300)}... [Full report available in Kilo Guardian]`;
            const smsBody = encodeURIComponent(shortSummary);

            // Try to open SMS (works on mobile)
            window.location.href = `sms:?body=${smsBody}`;

            // Show fallback with full data
            setTimeout(() => {
                const confirmed = confirm('SMS app opened with summary. Would you like to copy the full report to clipboard?');
                if (confirmed) {
                    copyToClipboard(dataObj, title);
                }
            }, 1000);
        }

        function copyToClipboard(dataObj, title) {
            const formattedData = formatDataForExport(dataObj, title);
            const textData = stripHTML(formattedData);
            const fullText = `${title}\n${'='.repeat(title.length)}\n\nGenerated: ${new Date().toLocaleString()}\nSystem: Kilo Guardian - Bastion AI\n\n${textData}`;

            navigator.clipboard.writeText(fullText).then(() => {
                alert('✅ Report copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = fullText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('✅ Report copied to clipboard!');
            });
        }

        function formatDataForExport(dataObj, title) {
            let html = '';

            // Format based on data type
            if (dataObj.type === 'budget_status' && dataObj.budgets) {
                html += '<h2>Budget Summary</h2>';
                html += '<table><thead><tr><th>Category</th><th>Limit</th><th>Spent</th><th>Remaining</th><th>Status</th></tr></thead><tbody>';
                dataObj.budgets.forEach(b => {
                    html += `<tr><td>${b.category}</td><td>$${b.limit?.toFixed(2)}</td><td>$${b.spent?.toFixed(2)}</td><td>$${b.remaining?.toFixed(2)}</td><td>${b.status}</td></tr>`;
                });
                html += '</tbody></table>';
            }

            if (dataObj.type === 'spending_summary') {
                html += '<h2>Spending Summary</h2>';
                html += `<p><strong>Income:</strong> $${dataObj.total_income?.toFixed(2)}</p>`;
                html += `<p><strong>Expenses:</strong> $${dataObj.total_expenses?.toFixed(2)}</p>`;
                html += `<p><strong>Net:</strong> $${dataObj.net?.toFixed(2)} (${dataObj.status})</p>`;

                if (dataObj.top_expenses && dataObj.top_expenses.length > 0) {
                    html += '<h3>Top Expenses</h3><table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead><tbody>';
                    dataObj.top_expenses.forEach(e => {
                        html += `<tr><td>${e.date}</td><td>${e.description}</td><td>${e.category}</td><td>$${e.amount?.toFixed(2)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
            }

            if (dataObj.type === 'goals_status' && dataObj.goals) {
                html += '<h2>Financial Goals</h2>';
                dataObj.goals.forEach(g => {
                    html += `<div class="summary-box">`;
                    html += `<h3>${g.name}</h3>`;
                    html += `<p><strong>Target:</strong> $${g.target?.toFixed(2)} | <strong>Current:</strong> $${g.current?.toFixed(2)} | <strong>Progress:</strong> ${g.progress?.toFixed(1)}%</p>`;
                    html += `<p><strong>Priority:</strong> ${g.priority} | <strong>Deadline:</strong> ${g.deadline} | <strong>Days Remaining:</strong> ${g.days_remaining}</p>`;
                    html += `</div>`;
                });
            }

            if (dataObj.type === 'spending_analysis') {
                html += '<h2>Spending Analysis</h2>';
                html += `<p><strong>Period:</strong> ${dataObj.period}</p>`;
                html += `<p><strong>Average Transaction:</strong> $${dataObj.average_transaction?.toFixed(2)}</p>`;

                if (dataObj.patterns && dataObj.patterns.length > 0) {
                    html += '<h3>Patterns</h3><ul>';
                    dataObj.patterns.forEach(p => html += `<li>${p}</li>`);
                    html += '</ul>';
                }

                if (dataObj.category_breakdown && dataObj.category_breakdown.length > 0) {
                    html += '<h3>Category Breakdown</h3><table><thead><tr><th>Category</th><th>Total</th><th>Transactions</th></tr></thead><tbody>';
                    dataObj.category_breakdown.forEach(c => {
                        html += `<tr><td>${c.category}</td><td>$${c.total?.toFixed(2)}</td><td>${c.transactions}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
            }

            if (dataObj.type === 'grocery_lists' && dataObj.lists) {
                html += '<h2>Grocery Lists</h2>';
                dataObj.lists.forEach(l => {
                    html += `<div class="summary-box">`;
                    html += `<h3>${l.name}</h3>`;
                    html += `<p><strong>Created:</strong> ${l.created} | <strong>Items:</strong> ${l.checked_items}/${l.total_items} | <strong>Status:</strong> ${l.completed ? 'Completed' : 'In Progress'}</p>`;
                    html += `</div>`;
                });
            }

            if (dataObj.type === 'financial_advice' && dataObj.advice) {
                html += '<h2>Financial Advice</h2>';
                dataObj.advice.forEach(a => {
                    html += `<div class="summary-box">`;
                    html += `<h3>${a.category} (${a.priority} priority)</h3>`;
                    html += `<p>${a.suggestion}</p>`;
                    html += `<p><em>Action: ${a.action}</em></p>`;
                    html += `</div>`;
                });
            }

            return html || '<p>No data available for export.</p>';
        }

        function stripHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        function renderNetworkSecurity(data) {
            const response = document.getElementById('chatResponse');

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            let html = `
                <div style="background: #2a2a2a; padding: 20px; border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                        <h2 style="margin: 0; color: #00ff88; border-bottom: 2px solid #00ff88; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-shield-alt"></i> Network Security
                        </h2>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="openNetworkConfigModal()" style="background: #111; color: #00ff88; border: 1px solid #00ff88; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-sliders-h"></i> Configure
                            </button>
                            <button onclick="executePlugin('network_security')" style="background: #00ff88; color: #000; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 700;">
                                <i class="fas fa-sync"></i> Rescan
                            </button>
                        </div>
                    </div>
            `;

            // Show status message
            if (data.content && data.content.message) {
                html += `<p style="color: #00ff88; margin: 15px 0; font-size: 14px;">${escapeHtml(data.content.message)}</p>`;
            } else {
                html += `<p style="color: #888; margin: 15px 0; font-size: 14px;">Network security status updated.</p>`;
            }

            // If scan not yet run, show help
            if (data.type === 'network_security_help') {
                html += `
                    <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 15px; margin: 15px 0;">
                        <h3 style="margin: 0 0 10px 0; color: #00ff88;">📋 Available Commands:</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #ccc;">
                            <li style="margin: 8px 0;"><strong>scan network</strong> - Discover all devices on local network</li>
                            <li style="margin: 8px 0;"><strong>security check</strong> - Run comprehensive security scan</li>
                            <li style="margin: 8px 0;"><strong>list devices</strong> - Show previously discovered devices</li>
                        </ul>
                    </div>
                `;

                // Show quick action button
                html += `
                    <button onclick="executePlugin('network_security')" style="
                        background: #00ff88;
                        color: #000;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        font-weight: bold;
                        cursor: pointer;
                        margin-top: 10px;
                        font-size: 14px;
                        transition: all 0.3s;
                    " onmouseover="this.style.background='#00cc66'; this.style.boxShadow='0 0 20px rgba(0,255,136,0.5)';" 
                       onmouseout="this.style.background='#00ff88'; this.style.boxShadow='none';">
                        <i class="fas fa-play"></i> Scan Network Now
                    </button>
                `;
            }

            // If scan complete, show devices
            if (data.type === 'network_scan_complete' && data.content && data.content.devices) {
                const devices = data.content.devices;
                const onlineCount = devices.filter(d => d.online).length;
                const stats = data.content.stats || {};
                const openPortsTotal = stats.openPorts ?? 0;
                const vulnCount = stats.vulnerabilities ?? 0;
                const iotDevices = stats.iotDevices ?? 0;

                // Summary stats
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin: 15px 0;">
                        <div style="background: #1a1a1a; border: 1px solid #00ff88; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TOTAL DEVICES</div>
                            <div style="color: #00ff88; font-size: 28px; font-weight: bold;">${devices.length}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #00ff88; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">ONLINE</div>
                            <div style="color: #00ff88; font-size: 28px; font-weight: bold;">${onlineCount}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #00ff88; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">OPEN PORTS (TOTAL)</div>
                            <div style="color: ${openPortsTotal > 0 ? '#ffaa00' : '#00ff88'}; font-size: 24px; font-weight: bold;">${openPortsTotal}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid ${vulnCount > 0 ? '#ff4444' : '#00ff88'}; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">VULNERABILITIES</div>
                            <div style="color: ${vulnCount > 0 ? '#ff4444' : '#00ff88'}; font-size: 24px; font-weight: bold;">${vulnCount}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #00ff88; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">IOT DEVICES</div>
                            <div style="color: #00ff88; font-size: 24px; font-weight: bold;">${iotDevices}</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #00ff88; border-radius: 6px; padding: 15px; text-align: center;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">STATUS</div>
                            <div style="color: #4CAF50; font-size: 20px; font-weight: bold;">✓ ACTIVE</div>
                        </div>
                    </div>
                `;

                // Device list
                html += `<div style="margin-top: 20px;"><h3 style="color: #00ff88; margin: 0 0 15px 0;">🔍 Discovered Devices:</h3>`;

                devices.forEach((device, idx) => {
                    const statusColor = device.online ? '#4CAF50' : '#ff9800';
                    const statusText = device.online ? 'ONLINE' : 'OFFLINE';
                    const deviceName = escapeHtml(device.name || 'Unknown Device');
                    const mac = escapeHtml(device.mac || 'unknown');
                    const ip = escapeHtml(device.ip || 'N/A');
                    const openPorts = Array.isArray(device.openPorts) ? device.openPorts : [];
                    const portText = openPorts.length ? openPorts.join(', ') : 'none';
                    html += `
                        <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 12px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="color: #888; font-size: 11px; margin-bottom: 3px;">IP ADDRESS</div>
                                <div style="color: #00ff88; font-family: monospace; font-weight: bold;">${ip}</div>
                            </div>
                            <div>
                                <div style="color: #ccc; margin-bottom: 3px;">
                                    <i class="fas fa-laptop"></i> ${deviceName}
                                </div>
                                <div style="color: #888; font-size: 12px; font-family: monospace;">MAC: ${mac}</div>
                                <div style="color: #888; font-size: 12px; font-family: monospace;">Ports: ${escapeHtml(portText)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: ${statusColor}; color: #000; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block;">
                                    ${statusText}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            html += '</div>';
            response.innerHTML = html;
        }

        function openNetworkConfigModal() {
            const status = document.getElementById('networkConfigStatus');
            status.textContent = 'Loading current settings...';

            fetch(API_BASE_URL + '/api/network/config', {
                headers: { 'X-API-Key': API_KEY }
            })
                .then(r => r.json())
                .then(data => {
                    networkConfig = data.config || {};
                    setNetworkConfigForm(networkConfig);
                    status.textContent = 'Loaded.';
                })
                .catch(err => {
                    status.textContent = 'Failed to load: ' + err.message;
                });

            openModal('networkConfigModal');
        }

        function setNetworkConfigForm(cfg = {}) {
            document.getElementById('cfgScanMethod').value = cfg.scan_method || 'auto';
            document.getElementById('cfgPortScan').checked = !!cfg.enable_port_scan;
            document.getElementById('cfgIncludeOffline').checked = cfg.include_offline_devices !== false;
            document.getElementById('cfgBrowserExtension').checked = cfg.browser_extension_enabled !== false;
            const dc = cfg.data_collection || {};
            document.getElementById('cfgCollectMetadata').checked = dc.collect_device_metadata !== false;
            document.getElementById('cfgCollectPorts').checked = !!dc.collect_open_ports;
            document.getElementById('cfgCollectSecurityEvents').checked = dc.collect_security_events !== false;
            document.getElementById('cfgCollectBrowserEvents').checked = dc.collect_browser_events !== false;
        }

        function saveNetworkConfig() {
            const status = document.getElementById('networkConfigStatus');
            status.textContent = 'Saving...';

            const payload = {
                scan_method: document.getElementById('cfgScanMethod').value,
                enable_port_scan: document.getElementById('cfgPortScan').checked,
                include_offline_devices: document.getElementById('cfgIncludeOffline').checked,
                browser_extension_enabled: document.getElementById('cfgBrowserExtension').checked,
                data_collection: {
                    collect_device_metadata: document.getElementById('cfgCollectMetadata').checked,
                    collect_open_ports: document.getElementById('cfgCollectPorts').checked,
                    collect_security_events: document.getElementById('cfgCollectSecurityEvents').checked,
                    collect_browser_events: document.getElementById('cfgCollectBrowserEvents').checked,
                }
            };

            fetch(API_BASE_URL + '/api/network/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': API_KEY
                },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(data => {
                    networkConfig = data.config || payload;
                    status.textContent = 'Saved.';
                })
                .catch(err => {
                    status.textContent = 'Save failed: ' + err.message;
                });
        }

        // Menu actions
        function showDiagnostics() {
            openModal('diagnosticsModal');
            document.getElementById('diagnosticsData').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Loading diagnostics...</div>';
            fetch(API_BASE_URL + '/api/system/health', {
                headers: {
                    'X-API-Key': API_KEY
                }
            })
                .then(r => r.json())
                .then(data => {
                    let html = '<div style="display: grid; gap: 15px;">';

                    // Status section
                    const statusColor = data.status === 'operational' ? '#00ff88' : data.status === 'degraded' ? '#ffaa00' : '#ff4444';
                    html += `
                        <div style="background: #0a0a0a; border: 1px solid ${statusColor}; border-radius: 8px; padding: 15px;">
                            <div style="font-size: 12px; color: #888; margin-bottom: 5px;">SYSTEM STATUS</div>
                            <div style="font-size: 24px; color: ${statusColor}; font-weight: bold; text-transform: uppercase;">${data.status || 'unknown'}</div>
                        </div>
                    `;

                    // CPU section
                    if (data.cpu !== undefined) {
                        const cpuColor = data.cpu > 80 ? '#ff4444' : data.cpu > 60 ? '#ffaa00' : '#00ff88';
                        html += `
                            <div style="background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 15px;">
                                <div style="font-size: 12px; color: #888; margin-bottom: 5px;">CPU USAGE</div>
                                <div style="font-size: 24px; color: ${cpuColor}; font-weight: bold;">${data.cpu.toFixed(1)}%</div>
                            </div>
                        `;
                    }

                    // Memory section
                    if (data.memory !== undefined) {
                        const memColor = data.memory > 80 ? '#ff4444' : data.memory > 60 ? '#ffaa00' : '#00ff88';
                        html += `
                            <div style="background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 15px;">
                                <div style="font-size: 12px; color: #888; margin-bottom: 5px;">MEMORY USAGE</div>
                                <div style="font-size: 24px; color: ${memColor}; font-weight: bold;">${data.memory.toFixed(1)}%</div>
                            </div>
                        `;
                    }

                    // Uptime section
                    if (data.uptime) {
                        html += `
                            <div style="background: #0a0a0a; border: 1px solid #333; border-radius: 8px; padding: 15px;">
                                <div style="font-size: 12px; color: #888; margin-bottom: 5px;">UPTIME</div>
                                <div style="font-size: 18px; color: #00aaff; font-weight: bold;">${data.uptime}</div>
                            </div>
                        `;
                    }

                    html += '</div>';
                    document.getElementById('diagnosticsData').innerHTML = html;
                })
                .catch(e => {
                    recordConnectionFailure('loading diagnostics');
                    document.getElementById('diagnosticsData').innerHTML = `<div style="color: #ff4444; padding: 20px;">Error: ${e.message}</div>`;
                });
            toggleMenu();
        }

        function showWizard() {
            window.location.href = '/wizard';
        }

        function showFaces() {
            openModal('facesModal');
            document.getElementById('facesData').textContent = 'Loading stored faces...';
            fetch(API_BASE_URL + '/api/faces', {
                headers: {
                    'X-API-Key': API_KEY
                }
            })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('facesData').textContent = JSON.stringify(data, null, 2);
                })
                .catch(e => {
                    recordConnectionFailure('loading faces');
                    document.getElementById('facesData').textContent = `Error: ${e.message}`;
                });
            toggleMenu();
        }

        function showLogs() {
            openModal('logsModal');
            document.getElementById('logsData').textContent = 'Loading system logs...';
            fetch(API_BASE_URL + '/api/logs', {
                headers: {
                    'X-API-Key': API_KEY
                }
            })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('logsData').textContent = JSON.stringify(data, null, 2);
                })
                .catch(e => {
                    recordConnectionFailure('loading logs');
                    document.getElementById('logsData').textContent = `Error: ${e.message}`;
                });
            toggleMenu();
        }

        function showAlerts() {
            openModal('alertsModal');
            document.getElementById('alertsData').innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">Loading security alerts...</div>';
            fetch(API_BASE_URL + '/api/alerts', {
                headers: {
                    'X-API-Key': API_KEY
                }
            })
                .then(r => r.json())
                .then(data => {
                    const alerts = data.alerts || [];

                    if (alerts.length === 0) {
                        document.getElementById('alertsData').innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-shield-alt" style="font-size: 48px; color: #00ff88; margin-bottom: 15px;"></i>
                    recordConnectionFailure('loading alerts');
                                <div style="font-size: 18px; color: #00ff88; font-weight: bold;">ALL CLEAR</div>
                                <div style="font-size: 14px; color: #888; margin-top: 10px;">No security threats detected</div>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

                    alerts.forEach(alert => {
                        const severityColor =
                            alert.severity === 'critical' ? '#ff0055' :
                                alert.severity === 'high' ? '#ff4444' :
                                    alert.severity === 'medium' ? '#ffaa00' : '#00aaff';

                        html += `
                            <div style="background: #0a0a0a; border-left: 4px solid ${severityColor}; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="font-weight: bold; color: ${severityColor}; text-transform: uppercase; font-size: 12px;">
                                        ${alert.severity || 'unknown'}
                                    </div>
                                    <div style="font-size: 11px; color: #666;">
                                        ${alert.timestamp || 'unknown time'}
                                    </div>
                                </div>
                                <div style="color: #fff; font-size: 14px; margin-bottom: 5px;">
                                    ${alert.message || alert.description || 'No description'}
                                </div>
                                ${alert.source ? `<div style="font-size: 12px; color: #888;">Source: ${alert.source}</div>` : ''}
                            </div>
                        `;
                    });

                    html += '</div>';
                    document.getElementById('alertsData').innerHTML = html;
                })
                .catch(e => {
                    document.getElementById('alertsData').innerHTML = `<div style="color: #ff4444; padding: 20px;">Error: ${e.message}</div>`;
                });
            toggleMenu();
        }

        function restartSystem() {
            if (confirm('Are you sure you want to restart the system?')) {
                fetch(API_BASE_URL + '/api/restart', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'kilo-dev-key-2025'
                    }
                })
                    .then(() => alert('System restarting...'))
                    .catch(e => alert('Error: ' + e.message));
            }
            toggleMenu();
        }

        function shutdownSystem() {
            if (confirm('Are you sure you want to shut down the system?')) {
                fetch(API_BASE_URL + '/api/shutdown', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': 'kilo-dev-key-2025'
                    }
                })
                    .then(() => alert('System shutting down...'))
                    .catch(e => alert('Error: ' + e.message));
            }
            toggleMenu();
        }

        // Fullscreen toggle
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error entering fullscreen:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Update fullscreen button text
        document.addEventListener('fullscreenchange', () => {
            const text = document.getElementById('fullscreenText');
            if (text) {
                text.textContent = document.fullscreenElement ? 'Exit Fullscreen' : 'Enter Fullscreen';
            }
        });

        // AI Name Management
        function updateAiName() {
            const name = aiName.toUpperCase();
            document.getElementById('headerAiName').textContent = name;
            document.getElementById('aiNameLabel').textContent = name;
            document.title = `${aiName} - Security Dashboard`;
        }

        function changeAiName() {
            const newName = prompt('Enter new AI name:', aiName);
            if (newName && newName.trim()) {
                aiName = newName.trim();
                localStorage.setItem('aiName', aiName);
                updateAiName();
            }
            toggleMenu();
        }

        // Modal helpers
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // File Upload Handler
        // Open Drone Control in new window
        function openDroneControl() {
            const width = 1400;
            const height = 900;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(
                '/drone-control.html',
                'DroneControl',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        }

        // Open Meshtastic Tracker in new window
        function openMeshtasticTracker() {
            const width = 1400;
            const height = 900;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(
                '/meshtastic-tracker.html',
                'MeshtasticTracker',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        }

        // Open VPN Manager in new window
        function openVPNManager() {
            const width = 1400;
            const height = 900;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(
                '/vpn-manager.html',
                'VPNManager',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        }

        // Open VPN Client in new window
        function openVPNClient() {
            const width = 800;
            const height = 900;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(
                '/vpn-client.html',
                'VPNClient',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        }

        function handleUpload(type) {
            const acceptTypes = {
                'csv': '.csv',
                'receipt': 'image/*,.pdf',
                'bill': 'image/*,.pdf',
                'document': 'image/*,.pdf,.doc,.docx,.csv'
            };

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = acceptTypes[type] || '*';
            input.multiple = true; // Allow multiple file selection
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', type);

                const response = document.getElementById('chatResponse');
                response.textContent = `Uploading ${type}: ${file.name}...`;

                try {
                    const result = await fetch(API_BASE_URL + '/api/upload/financial-document', {
                        method: 'POST',
                        headers: {
                            'X-API-Key': 'kilo-dev-key-2025'
                        },
                        body: formData
                    });

                    if (result.ok) {
                        let data;
                        const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                        if (resultContentType && resultContentType.includes('application/json')) {
                            data = await result.json();
                        } else {
                            const text = await result.text();
                            data = { answer: text };
                        }
                        response.textContent = JSON.stringify(data, null, 2);
                    } else {
                        response.textContent = `Upload failed: ${result.statusText}`;
                    }
                } catch (error) {
                    response.textContent = `Error uploading file: ${error.message}`;
                }
            };
            input.click();
        }

        // Banking CSV Upload (legacy)
        function uploadBankingCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                const response = document.getElementById('chatResponse');
                response.textContent = 'Uploading and processing CSV...';

                try {
                    const result = await fetch(API_BASE_URL + '/api/upload/banking-csv', {
                        method: 'POST',
                        headers: {
                            'X-API-Key': 'kilo-dev-key-2025'
                        },
                        body: formData
                    });

                    if (result.ok) {
                        let data;
                        const resultContentType = result.headers.get('content-type') || result.headers.get('Content-Type') || '';
                        if (resultContentType && resultContentType.includes('application/json')) {
                            data = await result.json();
                        } else {
                            const text = await result.text();
                            data = { answer: text };
                        }
                        response.textContent = JSON.stringify(data, null, 2);
                    } else {
                        response.textContent = `Upload failed: ${result.statusText}`;
                    }
                } catch (error) {
                    response.textContent = `Error uploading CSV: ${error.message}`;
                }
            };
            input.click();
        }

        // Plugin Health Modal Functions

        function togglePluginHealthModal() {
            const modal = document.getElementById('pluginHealthModal');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'flex';
                loadPluginHealth();
            } else {
                modal.style.display = 'none';
            }
        }

        async function loadPluginHealth() {
            try {
                const response = await fetch(API_BASE_URL + '/api/plugins/health', {
                    headers: { 'X-API-Key': API_KEY }
                });

                if (!response.ok) {
                    document.getElementById('pluginHealthTable').innerHTML =
                        '<div style="color: #ff4444; padding: 20px; text-align: center;">Failed to load plugin health data</div>';
                    return;
                }

                pluginHealthData = await response.json();

                // Transform API response to expected structure
                // API returns: {sandbox_enabled, total, healthy, unhealthy, plugins}
                // We need: {summary: {total_plugins, healthy_count, unhealthy_count}, plugins}
                if (pluginHealthData && typeof pluginHealthData.total !== 'undefined') {
                    pluginHealthData = {
                        summary: {
                            total_plugins: pluginHealthData.total || 0,
                            healthy_count: pluginHealthData.healthy || 0,
                            unhealthy_count: pluginHealthData.unhealthy || 0
                        },
                        plugins: pluginHealthData.plugins || []
                    };
                } else if (!pluginHealthData || !pluginHealthData.summary) {
                    console.warn('Invalid plugin health data structure:', pluginHealthData);
                    pluginHealthData = {
                        summary: {
                            total_plugins: 0,
                            healthy_count: 0,
                            unhealthy_count: 0
                        },
                        plugins: []
                    };
                }

                // Update summary stats
                document.getElementById('modalTotalPlugins').textContent = pluginHealthData.summary.total_plugins || 0;
                document.getElementById('modalHealthyPlugins').textContent = pluginHealthData.summary.healthy_count || 0;
                document.getElementById('modalUnhealthyPlugins').textContent = pluginHealthData.summary.unhealthy_count || 0;

                // Update header indicator
                updatePluginHealthIndicator();

                // Display table
                filterPluginHealth();
            } catch (error) {
                console.error('Failed to load plugin health:', error);
                document.getElementById('pluginHealthTable').innerHTML =
                    '<div style="color: #ff4444; padding: 20px; text-align: center;">Error: ' + error.message + '</div>';
            }
        }

        function updatePluginHealthIndicator() {
            if (!pluginHealthData || !pluginHealthData.summary) return;

            const light = document.getElementById('pluginHealthLight');
            const summary = document.getElementById('pluginHealthSummary');

            if (!light || !summary) return;

            const { total_plugins = 0, healthy_count = 0, unhealthy_count = 0 } = pluginHealthData.summary;

            // Update light color
            if (unhealthy_count === 0) {
                light.className = 'light green';
            } else if (unhealthy_count < total_plugins / 2) {
                light.className = 'light yellow';
            } else {
                light.className = 'light red';
            }

            // Update text
            summary.textContent = `Plugins: ${healthy_count}/${total_plugins}`;
        }

        function filterPluginHealth() {
            if (!pluginHealthData || !pluginHealthData.plugins) return;

            const unhealthyOnly = document.getElementById('filterUnhealthy').checked;
            const isolationMode = document.getElementById('isolationFilter').value;
            const searchTerm = document.getElementById('searchPlugin').value.toLowerCase();

            let filtered = pluginHealthData.plugins.filter(plugin => {
                if (unhealthyOnly && plugin.healthy) return false;
                if (isolationMode && plugin.isolation_mode !== isolationMode) return false;
                if (searchTerm && !plugin.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            renderPluginHealthTable(filtered);
        }

        function renderPluginHealthTable(plugins) {
            const table = document.getElementById('pluginHealthTable');

            if (plugins.length === 0) {
                table.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">No plugins match the current filters</div>';
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead style="background: #111; border-bottom: 2px solid #00ff88;">
                        <tr>
                            <th style="padding: 10px; text-align: left;">Plugin Name</th>
                            <th style="padding: 10px; text-align: center;">Sandboxed</th>
                            <th style="padding: 10px; text-align: center;">Isolation</th>
                            <th style="padding: 10px; text-align: center;">Status</th>
                            <th style="padding: 10px; text-align: left;">Details</th>
                            <th style="padding: 10px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            plugins.forEach(plugin => {
                const statusColor = plugin.healthy ? '#00ff88' : '#ff4444';
                const statusText = plugin.healthy ? 'Healthy' : 'Unhealthy';
                const sandboxed = plugin.sandboxed ? '✓' : '✗';
                const isolation = plugin.isolation_mode || 'N/A';

                html += `
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding: 10px; color: #00ff88;">${plugin.name}</td>
                        <td style="padding: 10px; text-align: center;">${sandboxed}</td>
                        <td style="padding: 10px; text-align: center; text-transform: capitalize;">${isolation}</td>
                        <td style="padding: 10px; text-align: center; color: ${statusColor}; font-weight: bold;">${statusText}</td>
                        <td style="padding: 10px; color: #888; font-size: 12px;">${plugin.detail || 'OK'}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${!plugin.healthy ? `<button onclick="resetPluginHealth('${plugin.name}')" style="background: #ff8800; border: none; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold;"><i class="fas fa-redo"></i> Reset</button>` : '—'}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            table.innerHTML = html;
        }

        async function resetPluginHealth(pluginName) {
            try {
                const response = await fetch(API_BASE_URL + `/api/sandbox/reset/${pluginName}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.ok) {
                    // Reload health data
                    await loadPluginHealth();
                } else {
                    alert('Failed to reset plugin: ' + (await response.text()));
                }
            } catch (error) {
                console.error('Failed to reset plugin:', error);
                alert('Error resetting plugin: ' + error.message);
            }
        }

        async function resetAllPluginHealth() {
            if (!pluginHealthData || !pluginHealthData.plugins) return;

            if (!confirm('Reset all unhealthy plugins? This will attempt to restart them.')) {
                return;
            }

            const unhealthy = pluginHealthData.plugins.filter(p => !p.healthy);

            for (const plugin of unhealthy) {
                try {
                    await fetch(API_BASE_URL + `/api/sandbox/reset/${plugin.name}`, {
                        method: 'POST',
                        headers: { 'X-API-Key': API_KEY }
                    });
                } catch (error) {
                    console.error(`Failed to reset ${plugin.name}:`, error);
                }
            }

            // Reload health data after all resets
            await loadPluginHealth();
        }

        // Poll plugin health every 15 seconds
        setInterval(() => {
            if (pluginHealthData) {
                loadPluginHealth();
            }
        }, 15000);

        // Initialize on page load
        init();
    </script>

    const light = document.getElementById('systemLight');
    light.className = data.status === 'operational' ? 'light green' : 'light yellow';
    } catch (error) {
    console.error('Failed to load system info:', error);
    }
    }

    // Start the dashboard
    init();
    </script>
</body>

</html>