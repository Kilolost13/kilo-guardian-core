<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kilo Guardian - Setup Wizard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="icons/favicon-64.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #00ff88;
            min-height: 100vh;
            padding: 20px;
        }

        .wizard-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .wizard-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: #0a0a0a;
            border: 2px solid #00ff88;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .wizard-logo {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .wizard-logo img {
            width: 100%;
            height: 100%;
            border-radius: 15px;
        }

        .wizard-title {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            margin-bottom: 10px;
        }

        .wizard-subtitle {
            font-size: 16px;
            color: rgba(0, 255, 136, 0.7);
            letter-spacing: 1px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 30px;
            background: #0a0a0a;
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 20px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(0, 255, 136, 0.2);
            z-index: 0;
        }

        .progress-step:first-child::before {
            left: 50%;
        }

        .progress-step:last-child::before {
            right: 50%;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #0a0a0a;
            border: 2px solid rgba(0, 255, 136, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
            z-index: 1;
            font-size: 14px;
            font-weight: 700;
        }

        .progress-step.active .step-circle {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        }

        .progress-step.completed .step-circle {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        .progress-step.completed .step-circle::after {
            content: '‚úì';
        }

        .step-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(0, 255, 136, 0.5);
        }

        .progress-step.active .step-label {
            color: #00ff88;
            font-weight: 700;
        }

        .progress-bar {
            height: 8px;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #00ff88;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
        }

        /* Step Content */
        .step-content {
            background: #0a0a0a;
            border: 2px solid #00ff88;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            min-height: 500px;
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .step-title i {
            font-size: 32px;
        }

        .step-description {
            font-size: 14px;
            color: rgba(0, 255, 136, 0.7);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: #00ff88;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            color: #00ff88;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .form-input::placeholder {
            color: rgba(0, 255, 136, 0.4);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Face Capture */
        .face-capture-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .camera-preview {
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        #faceVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-placeholder {
            font-size: 64px;
            opacity: 0.3;
        }

        .captured-faces {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .face-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 10px;
        }

        .face-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .face-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .face-info {
            flex: 1;
        }

        .face-name {
            font-weight: 700;
            font-size: 14px;
        }

        .face-relation {
            font-size: 12px;
            color: rgba(0, 255, 136, 0.6);
        }

        .face-remove {
            width: 30px;
            height: 30px;
            background: #ff0055;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .face-remove:hover {
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.5);
        }

        /* News Preferences */
        .news-sources {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .source-option {
            background: #000;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .source-option:hover {
            border-color: #00ff88;
        }

        .source-option.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .source-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #00ff88;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
        }

        .source-option.selected .source-checkbox {
            background: #00ff88;
        }

        .source-option.selected .source-checkbox::after {
            content: '‚úì';
            font-weight: 700;
        }

        /* OAuth Buttons */
        .oauth-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .oauth-button {
            padding: 20px;
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            color: #00ff88;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .oauth-button:hover {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .oauth-button.connected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .oauth-button i {
            font-size: 24px;
        }

        /* Location */
        .location-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .location-card {
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-card:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transform: translateY(-5px);
        }

        .location-card i {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .location-card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .location-card-desc {
            font-size: 12px;
            color: rgba(0, 255, 136, 0.6);
        }

        /* Review Summary */
        .review-section {
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .review-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            color: rgba(0, 255, 136, 0.7);
            font-size: 13px;
        }

        .review-value {
            font-weight: 700;
            font-size: 14px;
        }

        /* Buttons */
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid rgba(0, 255, 136, 0.2);
        }

        .btn {
            padding: 15px 30px;
            border: 2px solid #00ff88;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-secondary {
            background: #000;
            color: #00ff88;
        }

        .btn-secondary:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        .btn-primary {
            background: #00ff88;
            color: #000;
        }

        .btn-primary:hover {
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.6);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Success Animation */
        .success-container {
            text-align: center;
            padding: 60px 20px;
        }

        .success-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPulse 1.5s ease infinite;
        }

        .success-icon img {
            width: 100%;
            height: 100%;
        }

        @keyframes successPulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            }

            50% {
                box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
            }
        }

        .success-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .success-message {
            font-size: 16px;
            color: rgba(0, 255, 136, 0.7);
            margin-bottom: 40px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="wizard-container">
        <!-- Header -->
        <div class="wizard-header">
            <div class="wizard-logo"><img src="icons/logo-128.png" alt="Kilo Guardian"></div>
            <div class="wizard-title">KILO GUARDIAN</div>
            <div class="wizard-subtitle">Setup Wizard - Let's Get You Protected</div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Personal</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Faces</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">News</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Location</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Connect</div>
                </div>
                <div class="progress-step" data-step="6">
                    <div class="step-circle">6</div>
                    <div class="step-label">Review</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 16.67%"></div>
            </div>
        </div>

        <!-- Step 1: Personal Information -->
        <div class="step-content active" data-step="1">
            <div class="step-title">
                <i class="fas fa-user-circle"></i>
                <span>Personal Information</span>
            </div>
            <div class="step-description">
                Let's start with the basics. What should Kilo call you, and what would you like to call Kilo?
            </div>

            <div class="form-group">
                <label class="form-label">Your Name</label>
                <input type="text" class="form-input" id="userName" placeholder="e.g., John Smith" />
            </div>

            <div class="form-group">
                <label class="form-label">What should I call you? (Preferred Name/Nickname)</label>
                <input type="text" class="form-input" id="preferredName" placeholder="e.g., John, Johnny, Boss" />
            </div>

            <div class="form-group">
                <label class="form-label">What would you like to call me?</label>
                <input type="text" class="form-input" id="assistantName" placeholder="e.g., Kilo, Guardian, Jarvis"
                    value="Kilo" />
            </div>

            <div class="button-container">
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Face Recognition -->
        <div class="step-content" data-step="2">
            <div class="step-title">
                <i class="fas fa-users"></i>
                <span>Face Recognition Setup</span>
            </div>
            <div class="step-description">
                Let's capture your face and the faces of people you trust. This helps Kilo recognize authorized
                individuals and alert you to strangers.
            </div>

            <div class="face-capture-container">
                <div>
                    <div class="camera-preview">
                        <video id="faceVideo" autoplay></video>
                        <div class="face-placeholder" id="facePlaceholder">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label class="form-label">Person's Name</label>
                            <input type="text" class="form-input" id="faceName" placeholder="e.g., Sarah" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Relationship</label>
                            <input type="text" class="form-input" id="faceRelation"
                                placeholder="e.g., Family, Friend, Roommate" />
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="captureFace()">
                            <i class="fas fa-camera"></i> Capture Face
                        </button>
                    </div>
                </div>

                <div>
                    <label class="form-label">Recognized Faces (<span id="faceCount">0</span>)</label>
                    <div class="captured-faces" id="capturedFaces">
                        <div style="text-align: center; padding: 40px; color: rgba(0, 255, 136, 0.5);">
                            <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <div>No faces captured yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-container">
                <button class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: News & Calendar Preferences -->
        <div class="step-content" data-step="3">
            <div class="step-title">
                <i class="fas fa-newspaper"></i>
                <span>News & Information Preferences</span>
            </div>
            <div class="step-description">
                Configure your daily briefing. Kilo can provide news, weather, and calendar updates when you ask.
            </div>

            <div class="form-group">
                <label class="form-label">What topics interest you?</label>
                <input type="text" class="form-input" id="newsTopics"
                    placeholder="e.g., Technology, Business, Local News, Sports" />
            </div>

            <div class="form-group">
                <label class="form-label">Preferred News Sources (Select all that apply)</label>
                <div class="news-sources">
                    <div class="source-option" onclick="toggleSource(this, 'reuters')">
                        <div class="source-checkbox"></div>
                        <div>Reuters</div>
                    </div>
                    <div class="source-option" onclick="toggleSource(this, 'ap')">
                        <div class="source-checkbox"></div>
                        <div>Associated Press</div>
                    </div>
                    <div class="source-option" onclick="toggleSource(this, 'bbc')">
                        <div class="source-checkbox"></div>
                        <div>BBC News</div>
                    </div>
                    <div class="source-option" onclick="toggleSource(this, 'npr')">
                        <div class="source-checkbox"></div>
                        <div>NPR</div>
                    </div>
                    <div class="source-option" onclick="toggleSource(this, 'local')">
                        <div class="source-checkbox"></div>
                        <div>Local News</div>
                    </div>
                    <div class="source-option" onclick="toggleSource(this, 'tech')">
                        <div class="source-checkbox"></div>
                        <div>Tech News</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Briefing Schedule</label>
                <select class="form-input" id="briefingTime">
                    <option value="morning">Morning (7:00 AM)</option>
                    <option value="afternoon">Afternoon (12:00 PM)</option>
                    <option value="evening">Evening (6:00 PM)</option>
                    <option value="ondemand">On-Demand Only</option>
                </select>
            </div>

            <div class="button-container">
                <button class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 4: Location -->
        <div class="step-content" data-step="4">
            <div class="step-title">
                <i class="fas fa-map-marker-alt"></i>
                <span>Location Setup</span>
            </div>
            <div class="step-description">
                Set your location for weather, local news, and emergency services information.
            </div>

            <div class="location-options">
                <div class="location-card" onclick="useGPS()">
                    <i class="fas fa-satellite-dish"></i>
                    <div class="location-card-title">Use GPS</div>
                    <div class="location-card-desc">Automatically detect my location</div>
                </div>
                <div class="location-card" onclick="manualLocation()">
                    <i class="fas fa-edit"></i>
                    <div class="location-card-title">Enter Manually</div>
                    <div class="location-card-desc">I'll type my location</div>
                </div>
            </div>

            <div class="form-group" id="manualLocationForm" style="display: none;">
                <label class="form-label">Your Location</label>
                <input type="text" class="form-input" id="userLocation" placeholder="e.g., New York, NY or 90210" />
            </div>

            <div class="form-group" id="gpsLocationDisplay" style="display: none;">
                <label class="form-label">Detected Location</label>
                <div
                    style="padding: 20px; background: #000; border: 2px solid #00ff88; border-radius: 8px; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 10px;"></i>
                    <div id="gpsStatus">Detecting location...</div>
                </div>
            </div>

            <div class="button-container">
                <button class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 5: OAuth Connections -->
        <div class="step-content" data-step="5">
            <div class="step-title">
                <i class="fas fa-link"></i>
                <span>Connect Your Accounts</span>
            </div>
            <div class="step-description">
                Connect your accounts to unlock powerful features like calendar integration, email monitoring, and cloud
                storage access. All connections are secure and encrypted.
            </div>

            <div class="oauth-container">
                <button class="oauth-button" onclick="connectOAuth('google')">
                    <i class="fab fa-google"></i>
                    <span>Connect Google</span>
                </button>
                <button class="oauth-button" onclick="connectOAuth('microsoft')">
                    <i class="fab fa-microsoft"></i>
                    <span>Connect Microsoft</span>
                </button>
                <button class="oauth-button" onclick="connectOAuth('gmail')">
                    <i class="fas fa-envelope"></i>
                    <span>Connect Gmail</span>
                </button>
                <button class="oauth-button" onclick="connectOAuth('calendar')">
                    <i class="fas fa-calendar"></i>
                    <span>Connect Calendar</span>
                </button>
                <button class="oauth-button" onclick="connectOAuth('dropbox')">
                    <i class="fab fa-dropbox"></i>
                    <span>Connect Dropbox</span>
                </button>
                <button class="oauth-button" onclick="connectOAuth('drive')">
                    <i class="fab fa-google-drive"></i>
                    <span>Connect Drive</span>
                </button>
            </div>

            <div
                style="padding: 20px; background: rgba(0, 255, 136, 0.1); border: 2px solid #00ff88; border-radius: 8px; margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-shield-alt" style="font-size: 24px;"></i>
                    <strong>Your Privacy Matters</strong>
                </div>
                <div style="font-size: 13px; color: rgba(0, 255, 136, 0.8); line-height: 1.6;">
                    Kilo uses OAuth 2.0 for secure authentication. Your credentials are never stored. You can disconnect
                    any service at any time from the settings menu.
                </div>
            </div>

            <div class="button-container">
                <button class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 6: Review & Confirm -->
        <div class="step-content" data-step="6">
            <div class="step-title">
                <i class="fas fa-check-circle"></i>
                <span>Review Your Setup</span>
            </div>
            <div class="step-description">
                Please review your configuration before we lock it in. You can always change these settings later.
            </div>

            <div class="review-section">
                <div class="review-title">
                    <i class="fas fa-user"></i> Personal Information
                </div>
                <div class="review-item">
                    <span class="review-label">Full Name:</span>
                    <span class="review-value" id="reviewUserName">-</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Preferred Name:</span>
                    <span class="review-value" id="reviewPreferredName">-</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Assistant Name:</span>
                    <span class="review-value" id="reviewAssistantName">Kilo</span>
                </div>
            </div>

            <div class="review-section">
                <div class="review-title">
                    <i class="fas fa-users"></i> Face Recognition
                </div>
                <div class="review-item">
                    <span class="review-label">Recognized Faces:</span>
                    <span class="review-value" id="reviewFaceCount">0</span>
                </div>
            </div>

            <div class="review-section">
                <div class="review-title">
                    <i class="fas fa-newspaper"></i> News Preferences
                </div>
                <div class="review-item">
                    <span class="review-label">Topics:</span>
                    <span class="review-value" id="reviewTopics">-</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Sources:</span>
                    <span class="review-value" id="reviewSources">-</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Briefing Time:</span>
                    <span class="review-value" id="reviewBriefingTime">-</span>
                </div>
            </div>

            <div class="review-section">
                <div class="review-title">
                    <i class="fas fa-map-marker-alt"></i> Location
                </div>
                <div class="review-item">
                    <span class="review-label">Location:</span>
                    <span class="review-value" id="reviewLocation">-</span>
                </div>
            </div>

            <div class="review-section">
                <div class="review-title">
                    <i class="fas fa-link"></i> Connected Accounts
                </div>
                <div class="review-item">
                    <span class="review-label">Services:</span>
                    <span class="review-value" id="reviewConnected">None</span>
                </div>
            </div>

            <div class="button-container">
                <button class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-primary" onclick="lockInPreferences()">
                    <i class="fas fa-lock"></i> Lock In Preferences
                </button>
            </div>
        </div>

        <!-- Step 7: Success -->
        <div class="step-content" data-step="7">
            <div class="success-container">
                <div class="success-icon">
                    <img src="icons/success-128.png" alt="Success">
                </div>
                <div class="success-title">Setup Complete!</div>
                <div class="success-message">
                    Your preferences have been saved and encrypted. Kilo Guardian is now configured to protect you and
                    your space.<br><br>
                    You're all set! Let's get started.
                </div>
                <button class="btn btn-primary" style="margin: 0 auto;" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> Go to Dashboard
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8001';
        const API_KEY = 'kilo-dev-key-2025';

        // Configuration object to store all wizard data
        const wizardData = {
            personal: {
                userName: '',
                preferredName: '',
                assistantName: 'Kilo'
            },
            faces: [],
            news: {
                topics: '',
                sources: [],
                briefingTime: 'ondemand'
            },
            location: {
                method: '',
                value: ''
            },
            oauth: {
                connected: []
            }
        };

        let currentStep = 1;
        let cameraStream = null;

        // Navigation functions
        function nextStep() {
            // Save current step data
            saveStepData(currentStep);

            if (currentStep < 6) {
                currentStep++;
                updateWizard();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizard();
            }
        }

        function updateWizard() {
            // Update step visibility
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');

            // Update progress indicators
            document.querySelectorAll('.progress-step').forEach(el => {
                const stepNum = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (stepNum < currentStep) {
                    el.classList.add('completed');
                } else if (stepNum === currentStep) {
                    el.classList.add('active');
                }
            });

            // Update progress bar
            const progress = (currentStep / 6) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // Special handling for face capture step
            if (currentStep === 2) {
                startCamera();
            } else {
                stopCamera();
            }

            // Update review step if we're there
            if (currentStep === 6) {
                updateReviewSummary();
            }
        }

        function saveStepData(step) {
            switch (step) {
                case 1:
                    wizardData.personal.userName = document.getElementById('userName').value;
                    wizardData.personal.preferredName = document.getElementById('preferredName').value;
                    wizardData.personal.assistantName = document.getElementById('assistantName').value;
                    break;
                case 3:
                    wizardData.news.topics = document.getElementById('newsTopics').value;
                    wizardData.news.briefingTime = document.getElementById('briefingTime').value;
                    break;
                case 4:
                    const manualLoc = document.getElementById('userLocation').value;
                    if (manualLoc) {
                        wizardData.location.method = 'manual';
                        wizardData.location.value = manualLoc;
                    }
                    break;
            }
        }

        // Face capture functions - uses central camera service
        let cameraStream = null;
        let captureInterval = null;

        async function startCamera() {
            try {
                const video = document.getElementById('faceVideo');

                // First, check if camera service is available
                const healthResponse = await fetch(API_BASE_URL + '/api/camera/health', {
                    headers: { 'X-API-Key': API_KEY }
                }).catch(() => null);

                if (healthResponse && healthResponse.ok) {
                    console.log('‚úÖ Using centralized camera service...');
                    // Use camera service stream (prioritized)
                    const img = new Image();
                    img.id = 'cameraFeedImage';
                    img.style.display = 'block';
                    img.style.width = '100%';
                    img.style.borderRadius = '6px';
                    img.style.backgroundColor = '#1a1a1a';

                    // Replace video with image for server-side camera feed
                    video.parentNode.insertBefore(img, video);
                    video.style.display = 'none';

                    // Start fetching frames from camera service
                    startCameraServiceFeed(img);
                    document.getElementById('facePlaceholder').style.display = 'none';
                } else {
                    // Fallback: try getUserMedia
                    console.log('üì∑ Camera service not available, trying getUserMedia...');
                    try {
                        cameraStream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                width: { ideal: 640 },
                                height: { ideal: 480 },
                                facingMode: 'user'
                            },
                            audio: false
                        });
                        video.srcObject = cameraStream;
                        document.getElementById('facePlaceholder').style.display = 'none';
                        console.log('‚úÖ Browser camera access granted');
                    } catch (userMediaError) {
                        console.error('‚ùå getUserMedia failed:', userMediaError.name, userMediaError.message);
                        throw new Error(`Camera not available: ${userMediaError.message}`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Camera initialization failed:', error);
                alert('Camera not available: ' + error.message +
                    '\n\nPossible solutions:\n' +
                    '- Check that camera is not in use by another app\n' +
                    '- Allow camera access in browser permissions\n' +
                    '- Try a different browser');
            }
        }

        function startCameraServiceFeed(imgElement) {
            // Get frame from camera service every 100ms
            captureInterval = setInterval(async () => {
                try {
                    const response = await fetch(API_BASE_URL + '/api/camera/0/frame', {
                        headers: { 'X-API-Key': API_KEY }
                    }).catch(() => null);

                    if (response && response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        imgElement.src = url;
                    }
                } catch (e) {
                    console.debug('Frame fetch error (will retry):', e.message);
                }
            }, 100);
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
        }

        function captureFace() {
            const name = document.getElementById('faceName').value.trim();
            const relation = document.getElementById('faceRelation').value.trim();

            if (!name) {
                alert('Please enter a name for this face.');
                return;
            }

            // Try to capture from video element first, fall back to image
            let imageData = null;
            const video = document.getElementById('faceVideo');
            const img = document.getElementById('cameraFeedImage');
            const canvas = document.createElement('canvas');

            try {
                if (video && video.style.display !== 'none' && video.srcObject) {
                    // Using getUserMedia stream
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 480;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    imageData = canvas.toDataURL('image/jpeg');
                    console.log('üì∏ Captured face from browser camera');
                } else if (img && img.src) {
                    // Using camera service stream
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = img.naturalWidth || 640;
                    tempCanvas.height = img.naturalHeight || 480;
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    imageData = tempCanvas.toDataURL('image/jpeg');
                    console.log('üì∏ Captured face from camera service');
                }
            } catch (e) {
                console.error('‚ùå Error capturing frame:', e);
            }

            if (!imageData) {
                alert('Could not capture image. Make sure camera is working.');
                return;
            }

            wizardData.faces.push({
                name: name,
                relation: relation || 'Unknown',
                image: imageData,
                timestamp: new Date().toISOString()
            });

            // Clear inputs
            document.getElementById('faceName').value = '';
            document.getElementById('faceRelation').value = '';

            // Update display
            updateFacesList();
        }

        function updateFacesList() {
            const container = document.getElementById('capturedFaces');
            const count = wizardData.faces.length;
            document.getElementById('faceCount').textContent = count;

            if (count === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(0, 255, 136, 0.5);">
                        <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <div>No faces captured yet</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = wizardData.faces.map((face, index) => `
                <div class="face-item">
                    <div class="face-thumb">
                        <img src="${face.image}" alt="${face.name}">
                    </div>
                    <div class="face-info">
                        <div class="face-name">${face.name}</div>
                        <div class="face-relation">${face.relation}</div>
                    </div>
                    <button class="face-remove" onclick="removeFace(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFace(index) {
            wizardData.faces.splice(index, 1);
            updateFacesList();
        }

        // News sources toggle
        function toggleSource(element, source) {
            element.classList.toggle('selected');
            const index = wizardData.news.sources.indexOf(source);
            if (index > -1) {
                wizardData.news.sources.splice(index, 1);
            } else {
                wizardData.news.sources.push(source);
            }
        }

        // Location functions
        function useGPS() {
            document.getElementById('manualLocationForm').style.display = 'none';
            document.getElementById('gpsLocationDisplay').style.display = 'block';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);
                        wizardData.location.method = 'gps';
                        wizardData.location.value = `${lat}, ${lon}`;
                        document.getElementById('gpsStatus').innerHTML = `
                            <i class="fas fa-check-circle" style="color: #00ff88; font-size: 32px; margin-bottom: 10px;"></i>
                            <div>Location detected: ${lat}, ${lon}</div>
                        `;
                    },
                    (error) => {
                        document.getElementById('gpsStatus').innerHTML = `
                            <i class="fas fa-exclamation-circle" style="color: #ff0055; font-size: 32px; margin-bottom: 10px;"></i>
                            <div>Could not detect location. Please use manual entry.</div>
                        `;
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
                manualLocation();
            }
        }

        function manualLocation() {
            document.getElementById('gpsLocationDisplay').style.display = 'none';
            document.getElementById('manualLocationForm').style.display = 'block';
        }

        // OAuth connections
        function connectOAuth(service) {
            // In production, this would open OAuth flow
            alert(`Connecting to ${service}... (OAuth flow would start here)`);

            // Simulate successful connection
            if (!wizardData.oauth.connected.includes(service)) {
                wizardData.oauth.connected.push(service);
                event.target.closest('.oauth-button').classList.add('connected');
            }
        }

        // Review summary
        function updateReviewSummary() {
            document.getElementById('reviewUserName').textContent = wizardData.personal.userName || '-';
            document.getElementById('reviewPreferredName').textContent = wizardData.personal.preferredName || '-';
            document.getElementById('reviewAssistantName').textContent = wizardData.personal.assistantName || 'Kilo';

            document.getElementById('reviewFaceCount').textContent = wizardData.faces.length;

            document.getElementById('reviewTopics').textContent = wizardData.news.topics || '-';
            document.getElementById('reviewSources').textContent = wizardData.news.sources.join(', ') || 'None selected';
            document.getElementById('reviewBriefingTime').textContent = wizardData.news.briefingTime;

            document.getElementById('reviewLocation').textContent = wizardData.location.value || 'Not set';

            document.getElementById('reviewConnected').textContent =
                wizardData.oauth.connected.length > 0 ? wizardData.oauth.connected.join(', ') : 'None';
        }

        // Final submission
        async function lockInPreferences() {
            try {
                // Show loading state
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // Send to backend
                const response = await fetch(API_BASE_URL + '/api/wizard/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify(wizardData)
                });

                if (response.ok) {
                    console.log('‚úÖ Wizard saved successfully');
                    currentStep = 7;
                    updateWizard();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.detail || errorData.message || `Server error: ${response.status}`;
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('‚ùå Wizard save error:', error);
                alert('Error saving preferences: ' + error.message);
                const btn = event.target;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-lock"></i> Lock In Preferences';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>

</html>