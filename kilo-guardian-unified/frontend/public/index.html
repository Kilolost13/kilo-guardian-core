<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kilo Guardian AI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e6e6e6;
        }

        .chat-bubble-kilo {
            background-color: #1f2937;
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
        }

        .chat-bubble-user {
            background-color: #3b82f6;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
        }

        .glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .kilo-status-indicator {
            animation: pulse-glow 1.5s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px #10b981;
            }

            50% {
                box-shadow: 0 0 20px #10b981;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col antialiased">

    <!-- Header / Status Bar -->
    <header
        class="p-4 border-b border-gray-700/50 flex justify-between items-center sticky top-0 z-10 bg-gray-900/90 backdrop-blur-sm shadow-xl">
        <h1 class="text-xl font-bold text-teal-400">Kilo Guardian AI</h1>
        <div id="status-indicator" class="flex items-center space-x-2 text-sm">
            <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 kilo-status-indicator"></div>
            <span id="status-text" class="text-gray-400">Connecting...</span>
        </div>
    </header>

    <main class="flex-grow flex flex-col lg:flex-row p-4 overflow-y-auto">

        <!-- Left Panel: Chat Interface -->
        <div
            class="flex flex-col flex-grow lg:w-3/5 xl:w-2/3 bg-gray-800/50 p-4 rounded-xl shadow-lg border border-gray-700/50 mb-4 lg:mb-0 lg:mr-4">
            <div id="chat-window" class="flex-grow overflow-y-auto space-y-4 p-2 mb-4 custom-scrollbar">
                <!-- Initial Kilo Message -->
                <div class="flex justify-start">
                    <div class="chat-bubble-kilo max-w-lg p-3 text-sm">
                        <span class="font-semibold text-teal-400">Kilo:</span> Hey there! I'm Kilo, your digital
                        guardian. Try asking me "What is the agenda?" or "Security status?".
                    </div>
                </div>
            </div>

            <!-- Input Form -->
            <form id="chat-form" class="flex space-x-2">
                <input type="text" id="user-input" placeholder="Ask Kilo a question or give a command..."
                    class="flex-grow p-3 rounded-xl bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-white"
                    required>
                <button type="submit" id="send-button"
                    class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150 active:scale-95 glow disabled:opacity-50 disabled:cursor-not-allowed">
                    Send
                </button>
            </form>
        </div>

        <!-- Right Panel: Diagnostics & Video Feed -->
        <div class="lg:w-2/5 xl:w-1/3 space-y-4">

            <!-- Diagnostics Card -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700/50">
                <h2 class="text-lg font-semibold mb-3 text-orange-400">System Diagnostics</h2>
                <div id="diag-content" class="text-xs space-y-1">
                    <p>Status: <span id="diag-status" class="font-mono text-yellow-500">Loading...</span></p>
                    <p>Plugins Loaded: <span id="diag-plugins" class="font-mono text-blue-400">0</span></p>
                    <p>OS: <span id="diag-os" class="font-mono text-gray-400">N/A</span></p>
                </div>
            </div>

            <!-- Plugin List Card -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700/50">
                <h2 class="text-lg font-semibold mb-3 text-purple-400">Active Plugins</h2>
                <ul id="plugin-list" class="text-xs space-y-1 max-h-40 overflow-y-auto">
                    <!-- Plugins will be dynamically loaded here -->
                    <li class="text-gray-500">Loading plugins...</li>
                </ul>
            </div>

            <!-- Video Feed Card -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700/50">
                <h2 class="text-lg font-semibold mb-3 text-red-400">Security Camera Feed</h2>
                <!-- The video element will point to the StreamingResponse endpoint -->
                <img id="video-feed" src="/api/video_feed" alt="Security Camera Feed"
                    class="w-full h-auto rounded-lg border-2 border-gray-700/50"
                    onerror="this.src='https://placehold.co/640x480/374151/9ca3af?text=Camera+Unavailable'; this.onerror=null;">
                <p class="text-xs text-gray-500 mt-2">Note: Feed requires 'security_camera' plugin to be active.</p>
            </div>
        </div>
    </main>

    <script>
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatWindow = document.getElementById('chat-window');
        const sendButton = document.getElementById('send-button');

        // --- Utility Functions ---

        /** Creates and appends a chat bubble to the chat window. */
        function appendMessage(sender, message) {
            const isKilo = sender === 'Kilo';
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${isKilo ? 'justify-start' : 'justify-end'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-lg p-3 text-sm shadow-md ${isKilo ? 'chat-bubble-kilo' : 'chat-bubble-user'}`;

            let content = message;
            if (isKilo) {
                content = `<span class="font-semibold text-teal-400">Kilo:</span> ${message}`;
            }

            bubble.innerHTML = content;
            messageContainer.appendChild(bubble);
            chatWindow.appendChild(messageContainer);

            // Scroll to the bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        /** Fetches system diagnostics and updates the panel. */
        async function updateDiagnostics() {
            try {
                const apiKey = window.KILO_API_KEY || null;
                const headers = apiKey ? { 'X-API-Key': apiKey } : {};
                const response = await fetch('/api/diagnostics', { headers });
                const data = await response.json();

                document.getElementById('diag-status').textContent = data.status.toUpperCase();
                document.getElementById('diag-plugins').textContent = data.plugins;
                document.getElementById('diag-os').textContent = data.os_system;

                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');

                if (data.status === 'operational') {
                    statusDot.classList.remove('bg-red-500', 'bg-yellow-500');
                    statusDot.classList.add('bg-green-500');
                    statusText.textContent = 'Operational';
                } else {
                    statusDot.classList.remove('bg-red-500', 'bg-green-500');
                    statusDot.classList.add('bg-yellow-500');
                    statusText.textContent = 'Degraded';
                }
            } catch (error) {
                console.error("Failed to fetch diagnostics:", error);
                document.getElementById('diag-status').textContent = 'OFFLINE';
                document.getElementById('status-dot').classList.remove('bg-green-500', 'bg-yellow-500');
                document.getElementById('status-dot').classList.add('bg-red-500');
                document.getElementById('status-text').textContent = 'Offline';
            }
        }

        /** Fetches and lists active plugins. */
        async function updatePlugins() {
            try {
                const apiKey2 = window.KILO_API_KEY || null;
                const headers2 = apiKey2 ? { 'X-API-Key': apiKey2 } : {};
                const response = await fetch('/api/plugins', { headers: headers2 });
                const data = await response.json();

                const list = document.getElementById('plugin-list');
                list.innerHTML = ''; // Clear existing list

                if (data.plugins && data.plugins.length > 0) {
                    data.plugins.forEach(p => {
                        const li = document.createElement('li');
                        li.className = 'border-l-2 border-purple-500 pl-2';
                        li.innerHTML = `<span class="font-mono text-white">${p.name}</span> <span class="text-gray-400">(${p.description})</span>`;
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="text-gray-500">No plugins active.</li>';
                }

            } catch (error) {
                console.error("Failed to fetch plugins:", error);
                document.getElementById('plugin-list').innerHTML = '<li class="text-red-500">Error fetching plugin data.</li>';
            }
        }


        // --- Main Logic ---

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Display user message
            appendMessage('User', query);
            userInput.value = ''; // Clear input field

            // 2. Disable input and show loading
            sendButton.disabled = true;
            sendButton.textContent = 'Thinking...';
            userInput.disabled = true;

            // Add a temporary Kilo loading indicator
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'kilo-thinking';
            loadingMessage.className = 'flex justify-start';
            loadingMessage.innerHTML = '<div class="chat-bubble-kilo max-w-lg p-3 text-sm text-gray-400">Kilo is thinking...</div>';
            chatWindow.appendChild(loadingMessage);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                // 3. Send query to backend
                const apiKey3 = window.KILO_API_KEY || null;
                const headers3 = { 'Content-Type': 'application/json' };
                if (apiKey3) headers3['X-API-Key'] = apiKey3;
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers3,
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                // 4. Display Kilo's answer or handle structured/plugin responses
                document.getElementById('kilo-thinking').remove();

                const pluginResponse = data.answer || data;

                // If plugin returned an interactive form, render it
                if (pluginResponse && pluginResponse.type === 'interactive_form') {
                    renderInteractiveForm(pluginResponse);
                } else if (pluginResponse && typeof pluginResponse === 'object' && pluginResponse.content) {
                    // If structured content present, show as pretty JSON inside Kilo bubble
                    appendMessage('Kilo', '<pre style="white-space:pre-wrap;font-family:monospace;color:#9AE6B4;">' + escapeHtml(JSON.stringify(pluginResponse.content, null, 2)) + '</pre>');
                } else {
                    appendMessage('Kilo', pluginResponse.answer || pluginResponse || 'No response');
                }

            } catch (error) {
                console.error("Chat API Error:", error);
                document.getElementById('kilo-thinking').remove();
                appendMessage('Kilo', "Whoops! I can't connect to my brain right now. The server might be offline or busy. (Check the console for error details)");
            } finally {
                // 5. Re-enable input
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                userInput.disabled = false;
                userInput.focus();

                // Always refresh diagnostics after a chat operation
                updateDiagnostics();
                updatePlugins();
            }
        });

        // Initial load and periodic updates
        document.addEventListener('DOMContentLoaded', () => {
            // Run once on load
            // Fetch front-end config (API key) and store globally for subsequent calls.
            // Prefer server-side injection via window.KILO_API_KEY if available; fall back to /api/front-config.
            (async function loadFrontConfig() {
                try {
                    if (window.KILO_API_KEY) {
                        // already injected by server
                    } else {
                        try {
                            const cfg = await fetch('/api/front-config').then(r => r.json());
                            window.KILO_API_KEY = cfg.api_key;
                        } catch (e) {
                            console.warn('Failed to fetch front config', e);
                        }
                    }
                } catch (e) { console.warn('Front config initialization error', e); }
                updateDiagnostics();
                updatePlugins();
            })();

            // Setup interval for periodic updates (e.g., every 5 seconds)
            setInterval(updateDiagnostics, 5000);
            setInterval(updatePlugins, 10000);
        });

        // --- Interactive form renderer (minimal) ---
        function renderInteractiveForm(data) {
            const form = data.form || {};
            const title = form.title || 'Form';
            const message = data.message || '';

            // Build HTML for the form similar to legacy renderer but compact
            let html = `<div style="background:#0b1220;padding:16px;border-radius:8px;border:1px solid #223;">`;
            html += `<h3 style="color:#7EE787;margin:0 0 8px 0;">${escapeHtml(title)}</h3>`;
            if (message) html += `<p style="color:#9CA3AF;margin:0 0 12px 0;">${escapeHtml(message)}</p>`;
            html += `<form id="kilo-dynamic-form" style="display:flex;flex-direction:column;gap:8px;">`;

            (form.fields || []).forEach(field => {
                html += `<label style=\"color:#9CA3AF;font-size:13px;\">${escapeHtml(field.label || field.name || '')}${field.required ? ' *' : ''}</label>`;
                if (field.type === 'select') {
                    html += `<select name="${escapeHtml(field.name)}" style=\"padding:8px;background:#0b1220;color:#fff;border:1px solid #334;\">`;
                    (field.options || []).forEach(opt => { html += `<option value=\"${escapeHtml(opt)}\">${escapeHtml(opt)}</option>`; });
                    html += `</select>`;
                } else if (field.type === 'textarea') {
                    html += `<textarea name="${escapeHtml(field.name)}" style=\"padding:8px;background:#0b1220;color:#fff;border:1px solid #334;min-height:80px;\"></textarea>`;
                } else {
                    const inputType = (field.type === 'number' || field.type === 'date' || field.type === 'text') ? field.type : 'text';
                    html += `<input type=\"${inputType}\" name=\"${escapeHtml(field.name)}\" style=\"padding:8px;background:#0b1220;color:#fff;border:1px solid #334;\" />`;
                }

                // --- Manual entry prompt renderer (for manual_entry_prompt) ---
                function renderManualEntryPrompt(data) {
                    const content = data.content || {};
                    const title = content.message || 'Manual Entry';
                    const format = content.format || '';
                    const example = content.example || '';
                    const categories = content.categories || [];

                    let html = `<div style="background:#0b1220;padding:16px;border-radius:8px;border:1px solid #223;">`;
                    html += `<h3 style="color:#7EE787;margin:0 0 8px 0;">${escapeHtml(title)}</h3>`;
                    if (format) html += `<div style="color:#9CA3AF;margin-bottom:8px;font-size:13px;">Format: <code style=\"color:#cbd5e1;background:#071122;padding:2px 6px;border-radius:4px;\">${escapeHtml(format)}</code></div>`;
                    if (example) html += `<div style="color:#94a3b8;margin-bottom:12px;font-size:13px;">Example: <em>${escapeHtml(example)}</em></div>`;

                    html += `<form id=\"kilo-manual-entry-form\" style=\"display:flex;gap:8px;align-items:center;\">`;
                    html += `<input type=\"text\" id=\"kilo-manual-entry-input\" placeholder=\"Type your command...\" value=\"${escapeHtml(example)}\" style=\"flex:1;padding:8px;background:#0b1220;color:#fff;border:1px solid #334;border-radius:6px;\" />`;
                    html += `<button type=\"submit\" style=\"padding:8px 12px;background:#10B981;color:#fff;border-radius:6px;border:none;\">Send</button>`;
                    html += `</form>`;

                    if (categories.length > 0) {
                        html += `<div style=\"margin-top:10px;color:#9CA3AF;font-size:13px;\">Quick categories: `;
                        categories.forEach(cat => {
                            html += `<button data-cat=\"${escapeHtml(cat)}\" class=\"kilo-cat-btn\" style=\"margin-left:6px;padding:4px 8px;background:#122024;border:1px solid #234;border-radius:6px;color:#9EEBCF;cursor:pointer;\">${escapeHtml(cat)}</button>`;
                        });
                        html += `</div>`;
                    }

                    html += `</div>`;

                    appendMessage('Kilo', html);

                    setTimeout(() => {
                        const formEl = document.getElementById('kilo-manual-entry-form');
                        if (formEl) {
                            formEl.addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const input = document.getElementById('kilo-manual-entry-input');
                                const query = input.value.trim();
                                if (!query) return;
                                appendMessage('User', query);
                                try {
                                    const apiKeyInner = window.KILO_API_KEY || null;
                                    const headersInner = { 'Content-Type': 'application/json' };
                                    if (apiKeyInner) headersInner['X-API-Key'] = apiKeyInner;
                                    const res = await fetch('/api/chat', {
                                        method: 'POST',
                                        headers: headersInner,
                                        body: JSON.stringify({ query })
                                    });
                                    const resp = await res.json();
                                    const pluginResponse = resp.answer || resp;
                                    if (pluginResponse.type === 'interactive_form') {
                                        renderInteractiveForm(pluginResponse);
                                    } else if (pluginResponse.type === 'manual_entry_prompt') {
                                        renderManualEntryPrompt(pluginResponse);
                                    } else if (pluginResponse.content) {
                                        appendMessage('Kilo', '<pre style="white-space:pre-wrap;font-family:monospace;color:#9AE6B4;">' + escapeHtml(JSON.stringify(pluginResponse.content, null, 2)) + '</pre>');
                                    } else {
                                        appendMessage('Kilo', pluginResponse.answer || pluginResponse || 'No response');
                                    }
                                } catch (err) {
                                    appendMessage('Kilo', 'Error: ' + err.message);
                                }
                            });
                        }

                        // Category button handlers
                        document.querySelectorAll('.kilo-cat-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const cat = btn.getAttribute('data-cat');
                                const input = document.getElementById('kilo-manual-entry-input');
                                if (input) input.value = (input.value ? input.value + ' ' : '') + cat;
                            });
                        });
                    }, 50);
                }

                // --- Generic structured data renderer (finance-friendly) ---
                function renderStructuredData(data) {
                    const content = (data && data.content) ? data.content : (data || {});
                    const tool = data.tool || 'Response';

                    function escapeHtmlLocal(text) {
                        const div = document.createElement('div');
                        div.textContent = String(text);
                        return div.innerHTML;
                    }

                    let html = `<div style="background:#0b1220;padding:16px;border-radius:8px;border:1px solid #223;">`;
                    html += `<h3 style="color:#7EE787;margin:0 0 8px 0;">${escapeHtmlLocal(tool)}</h3>`;

                    if (typeof content === 'object' && !Array.isArray(content)) {
                        Object.entries(content).forEach(([key, value]) => {
                            html += `<div style="margin-bottom:12px;padding:10px;background:#071117;border-radius:6px;border-left:3px solid #123;">`;
                            html += `<strong style="color:#9EEBCF;text-transform:capitalize;">${escapeHtmlLocal(key)}</strong>`;

                            if (key === 'budgets' && Array.isArray(value)) {
                                html += `<div style="margin-top:8px;">`;
                                value.forEach(b => {
                                    html += `<div style="display:flex;justify-content:space-between;color:#cbd5e1;padding:6px 0;border-bottom:1px dashed #102;">`;
                                    html += `<div>${escapeHtmlLocal(b.category)}</div>`;
                                    html += `<div>${escapeHtmlLocal(b.spent)} / ${escapeHtmlLocal(b.limit)} (${escapeHtmlLocal(String(b.percentage.toFixed ? b.percentage.toFixed(1) : b.percentage))}%)</div>`;
                                    html += `</div>`;
                                });
                                html += `</div>`;
                            } else if ((key === 'top_expenses' || key === 'monthly_trend' || key === 'by_category') && Array.isArray(value)) {
                                html += `<pre style="white-space:pre-wrap;color:#cbd5e1;margin-top:8px;">${escapeHtmlLocal(JSON.stringify(value, null, 2))}</pre>`;
                            } else if (Array.isArray(value)) {
                                html += `<ul style="margin-top:8px;color:#cbd5e1;padding-left:16px;">`;
                                value.forEach(item => {
                                    html += `<li>${escapeHtmlLocal(typeof item === 'object' ? JSON.stringify(item) : String(item))}</li>`;
                                });
                                html += `</ul>`;
                            } else if (typeof value === 'object') {
                                html += `<pre style="white-space:pre-wrap;color:#cbd5e1;margin-top:8px;">${escapeHtmlLocal(JSON.stringify(value, null, 2))}</pre>`;
                            } else {
                                html += `<div style="color:#cbd5e1;margin-top:8px;">${escapeHtmlLocal(String(value))}</div>`;
                            }

                            html += `</div>`;
                        });
                    } else if (Array.isArray(content)) {
                        html += `<ul style="color:#cbd5e1;padding-left:16px;">`;
                        content.forEach(item => html += `<li>${escapeHtmlLocal(typeof item === 'object' ? JSON.stringify(item) : String(item))}</li>`);
                        html += `</ul>`;
                    } else {
                        html += `<div style="color:#cbd5e1;">${escapeHtmlLocal(String(content))}</div>`;
                    }

                    html += `</div>`;
                    appendMessage('Kilo', html);
                }

                // --- Finance help wrapper ---
                function renderFinanceHelp(data) {
                    // Reuse structured renderer for now
                    renderStructuredData(data);
                }
            });

            html += `<div style=\"display:flex;gap:8px;justify-content:flex-end;margin-top:8px;\"><button type=\"submit\" style=\"padding:8px 12px;background:#10B981;color:#fff;border-radius:6px;border:none;\">Submit</button></div>`;
            html += `</form></div>`;

            // Append as Kilo message bubble
            appendMessage('Kilo', html);

            // Hook up submit handler
            setTimeout(() => {
                const formEl = document.getElementById('kilo-dynamic-form');
                if (!formEl) return;
                formEl.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(formEl);
                    const payload = {};
                    for (const [k, v] of fd.entries()) payload[k] = v;
                    // Client-side validation & type mapping based on form.fields
                    const errors = [];
                    (form.fields || []).forEach(field => {
                        const name = field.name;
                        const val = payload[name];
                        if (field.required && (val === undefined || val === null || String(val).trim() === '')) {
                            errors.push(`${field.label || name} is required`);
                        }
                        if (val && field.type === 'number') {
                            const n = parseFloat(val);
                            if (isNaN(n)) errors.push(`${field.label || name} must be a number`);
                            else payload[name] = n;
                        }
                        if (val && field.type === 'date') {
                            // Normalize to ISO date string
                            try { payload[name] = new Date(val).toISOString(); } catch (e) { /* leave as-is */ }
                        }
                    });

                    if (errors.length > 0) {
                        appendMessage('Kilo', '<div style="color:#fca5a5;">Validation error: ' + escapeHtml(errors.join('; ')) + '</div>');
                        return;
                    }

                    // Send form back to backend specifying tool and action
                    appendMessage('Kilo', 'Submitting form...');
                    try {
                        const apiKeyForm = window.KILO_API_KEY || null;
                        const headersForm = { 'Content-Type': 'application/json' };
                        if (apiKeyForm) headersForm['X-API-Key'] = apiKeyForm;
                        const res = await fetch('/api/chat/submit', {
                            method: 'POST',
                            headers: headersForm,
                            body: JSON.stringify({ tool: data.tool, action: form.action || 'submit', data: payload })
                        });
                        const resp = await res.json();
                        appendMessage('Kilo', resp.message || resp.answer || JSON.stringify(resp));
                    } catch (err) {
                        appendMessage('Kilo', 'Error submitting form: ' + err.message);
                    }
                });
            }, 50);
        }

    </script>
</body>

</html>