---
# Patched deployments with /etc/hosts fixes for Docker Compose service names
# This allows containers to resolve ai_brain, library_of_truth, etc.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: kilo-gateway
  namespace: kilo-guardian
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kilo-gateway
  template:
    metadata:
      labels:
        app: kilo-gateway
    spec:
      containers:
      - name: gateway
        image: kilo/gateway:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8000
        env:
        - name: MEDS_URL
          value: "http://kilo-meds:9001"
        - name: REMINDER_URL
          value: "http://kilo-reminder:9002"
        - name: HABITS_URL
          value: "http://kilo-habits:9003"
        - name: AI_BRAIN_URL
          value: "http://kilo-ai-brain:9004"
        - name: FINANCIAL_URL
          value: "http://kilo-financial:9005"
        - name: LIBRARY_OF_TRUTH_URL
          value: "http://kilo-library:9006"
        - name: CAM_URL
          value: "http://kilo-cam:9007"
        - name: ML_ENGINE_URL
          value: "http://kilo-ml-engine:9008"
        - name: VOICE_URL
          value: "http://kilo-voice:9009"
        - name: USB_TRANSFER_URL
          value: "http://kilo-usb-transfer:8006"
        - name: LIBRARY_ADMIN_KEY
          value: "kilo-secure-admin-2024"
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "10.43.63.197 ai_brain" >> /etc/hosts
            echo "10.43.173.215 library_of_truth" >> /etc/hosts
            echo "10.43.144.204 reminder" >> /etc/hosts
            echo "10.43.214.225 meds" >> /etc/hosts
            echo "10.43.142.9 habits" >> /etc/hosts
            echo "10.43.216.158 financial" >> /etc/hosts
            echo "10.43.12.200 cam" >> /etc/hosts
            echo "10.43.196.200 ml_engine" >> /etc/hosts
            echo "10.43.236.231 voice" >> /etc/hosts
            exec /app/wait-for.sh ai_brain:9004 reminder:9002 -- uvicorn main:app --host 0.0.0.0 --port 8000
        readinessProbe:
          tcpSocket:
            port: 8000
          initialDelaySeconds: 15
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: 8000
          initialDelaySeconds: 40
          periodSeconds: 10

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kilo-meds
  namespace: kilo-guardian
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kilo-meds
  template:
    metadata:
      labels:
        app: kilo-meds
    spec:
      containers:
      - name: meds
        image: kilo/meds:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 9001
        env:
        - name: AI_BRAIN_URL
          value: "http://kilo-ai-brain:9004"
        - name: ALLOW_NETWORK
          value: "false"
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "10.43.63.197 ai_brain" >> /etc/hosts
            echo "10.43.173.215 library_of_truth" >> /etc/hosts
            exec python -m uvicorn main:app --host 0.0.0.0 --port 9001
        readinessProbe:
          tcpSocket:
            port: 9001
          initialDelaySeconds: 15
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: 9001
          initialDelaySeconds: 40
          periodSeconds: 10

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kilo-habits
  namespace: kilo-guardian
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kilo-habits
  template:
    metadata:
      labels:
        app: kilo-habits
    spec:
      containers:
      - name: habits
        image: kilo/habits:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 9003
        env:
        - name: AI_BRAIN_URL
          value: "http://kilo-ai-brain:9004"
        - name: ALLOW_NETWORK
          value: "false"
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "10.43.63.197 ai_brain" >> /etc/hosts
            echo "10.43.173.215 library_of_truth" >> /etc/hosts
            exec python -m uvicorn main:app --host 0.0.0.0 --port 9003
        readinessProbe:
          tcpSocket:
            port: 9003
          initialDelaySeconds: 15
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: 9003
          initialDelaySeconds: 40
          periodSeconds: 10

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kilo-financial
  namespace: kilo-guardian
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kilo-financial
  template:
    metadata:
      labels:
        app: kilo-financial
    spec:
      containers:
      - name: financial
        image: kilo/financial:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 9005
        env:
        - name: AI_BRAIN_URL
          value: "http://kilo-ai-brain:9004"
        - name: ALLOW_NETWORK
          value: "false"
        - name: SKIP_ALEMBIC
          value: "true"
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "10.43.63.197 ai_brain" >> /etc/hosts
            echo "10.43.173.215 library_of_truth" >> /etc/hosts
            sed -i 's/created_at: str/created_at: Optional[str] = None/g' main.py
            sed -i 's/return budgets/return {"budgets": budgets}/g' main.py
            sed -i 's/return goals/return {"goals": goals}/g' main.py
            exec python -m uvicorn main:app --host 0.0.0.0 --port 9005
        readinessProbe:
          tcpSocket:
            port: 9005
          initialDelaySeconds: 15
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: 9005
          initialDelaySeconds: 40
          periodSeconds: 10

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kilo-cam
  namespace: kilo-guardian
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kilo-cam
  template:
    metadata:
      labels:
        app: kilo-cam
    spec:
      containers:
      - name: cam
        image: kilo/cam:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 9007
        env:
        - name: AI_BRAIN_URL
          value: "http://kilo-ai-brain:9004"
        - name: ALLOW_NETWORK
          value: "false"
        - name: CAMERA_ENABLED
          value: "false"
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "10.43.63.197 ai_brain" >> /etc/hosts
            echo "10.43.173.215 library_of_truth" >> /etc/hosts
            echo "10.43.196.200 ml_engine" >> /etc/hosts
            exec python -m uvicorn main:app --host 0.0.0.0 --port 9007
        securityContext:
          privileged: true
        volumeMounts:
        - name: dev-video0
          mountPath: /dev/video0
        - name: dev-video1
          mountPath: /dev/video1
        readinessProbe:
          tcpSocket:
            port: 9007
          initialDelaySeconds: 15
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: 9007
          initialDelaySeconds: 40
          periodSeconds: 10
      volumes:
      - name: dev-video0
        hostPath:
          path: /dev/video0
          type: CharDevice
      - name: dev-video1
        hostPath:
          path: /dev/video1
          type: CharDevice
